{% extends 'admin/base.html' %}

{% block title %}Admin Dashboard - Product Calculator{% endblock %}

{% block extra_css %}
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/admin-dashboard.css') }}">
{% endblock %}

{% block extra_js %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let usersChart;
        let rolesChart;

        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardStats();
            loadChartData();
            initializeActionButtons();
        });

        function initializeActionButtons() {
            const actionHandlers = {
                addUser: () => addNewUser(),
                viewUsers: () => viewAllUsers(),
                viewQuotations: () => viewQuotationHistory(),
                viewSessions: () => showActiveSessionsModal()
            };

            document.querySelectorAll('.admin-action-btn').forEach(button => {
                const action = button.dataset.action;
                if (!action || !actionHandlers[action]) return;

                button.addEventListener('click', async () => {
                    if (button.classList.contains('btn-loading')) return;
                    const persist = button.dataset.persistLoading === 'true';
                    button.classList.add('btn-loading');

                    try {
                        const result = actionHandlers[action]();
                        if (result instanceof Promise) {
                            await result;
                        }
                    } finally {
                        if (!persist) {
                            button.classList.remove('btn-loading');
                        }
                    }
                });
            });
        }

        async function loadDashboardStats() {
            try {
                const response = await fetch('/api/admin/stats');
                const data = await response.json();

                if (data.error) {
                    console.error('Error loading stats:', data.error);
                    return;
                }

                const accounts = data.total_accounts ?? data.total_companies ?? 0;
                const totalUsers = data.total_users ?? 0;
                const activeSessions = data.active_sessions ?? 0;
                const totalQuotations = data.total_quotations ?? 0;
                const quotationsOnHold = data.quotations_on_hold ?? data.quotations_in_cart ?? 0;

                const accountsEl = document.getElementById('totalAccounts');
                if (accountsEl) accountsEl.textContent = accounts;

                const usersEl = document.getElementById('totalUsers');
                if (usersEl) usersEl.textContent = totalUsers;

                const activeSessionsEl = document.getElementById('activeSessions');
                if (activeSessionsEl) activeSessionsEl.textContent = activeSessions;

                const quotationsEl = document.getElementById('totalQuotations');
                if (quotationsEl) quotationsEl.textContent = totalQuotations;

                const quotationsOnHoldWrapper = document.getElementById('quotationsOnHoldWrapper');
                const quotationsOnHoldEl = document.getElementById('quotationsOnHold');
                if (quotationsOnHoldWrapper && quotationsOnHoldEl) {
                    quotationsOnHoldEl.textContent = quotationsOnHold;
                    quotationsOnHoldWrapper.classList.toggle('d-none', !quotationsOnHold);
                }

                updateRecentActivity(data.recent_activity || []);

            } catch (error) {
                console.error('Error loading dashboard stats:', error);
            }
        }

        async function loadChartData() {
            try {
                const response = await fetch('/api/admin/chart-data');
                const data = await response.json();

                if (data.error) {
                    console.error('Error loading chart data:', data.error);
                    return;
                }

                createUsersChart(data.users_by_month || []);
                createRolesChart(data.user_roles || []);
            } catch (error) {
                console.error('Error loading chart data:', error);
            }
        }

        function createUsersChart(data) {
            const canvas = document.getElementById('usersChart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');

            if (usersChart) {
                usersChart.destroy();
            }

            usersChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(item => item.month),
                    datasets: [{
                        label: 'New Users',
                        data: data.map(item => item.users),
                        borderColor: '#AD974F',
                        backgroundColor: 'rgba(173, 151, 79, 0.25)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Quotations Sent',
                        data: data.map(item => item.quotations),
                        borderColor: '#8E793E',
                        backgroundColor: 'rgba(142, 121, 62, 0.25)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function createRolesChart(data) {
            const canvas = document.getElementById('rolesChart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');

            if (rolesChart) {
                rolesChart.destroy();
            }

            rolesChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.map(item => item.role.charAt(0).toUpperCase() + item.role.slice(1)),
                    datasets: [{
                        data: data.map(item => item.count),
                        backgroundColor: [
                            '#AD974F',
                            '#8E793E',
                            '#050A30',
                            '#231F20',
                            '#8B8383',
                            '#EAEAEA'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function updateRecentActivity(activities) {
            const container = document.getElementById('recentActivity');
            if (!container) return;

            if (!activities.length) {
                container.innerHTML = '<div class="text-center text-muted">No recent activity</div>';
                return;
            }

            const html = activities.map(activity => `
                <div class="activity-item ${activity.role || ''}">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <strong>${activity.message}</strong>
                            <br>
                            <small class="text-muted">${activity.timestamp}</small>
                        </div>
                        <span class="badge bg-${activity.role === 'admin' ? 'danger' : 'success'} text-capitalize">
                            ${activity.role || 'user'}
                        </span>
                    </div>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        function addNewUser() {
            window.location.href = '/admin/manage-users?action=add';
        }

        function viewAllUsers() {
            window.location.href = '/admin/manage-users';
        }

        function viewQuotationHistory() {
            window.location.href = '/admin/quotations';
        }

        function showActiveSessionsModal() {
            return fetch('/api/admin/active-sessions')
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        throw new Error(data.error || 'Failed to load active sessions');
                    }
                    displayActiveSessionsModal(data.sessions || []);
                })
                .catch(error => {
                    console.error('Error loading active sessions:', error);
                    alert('Error loading active sessions');
                });
        }

        function displayActiveSessionsModal(sessions) {
            let modalHtml = `
                <div class="modal fade" id="activeSessionsModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Active User Sessions</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
            `;

            if (!sessions.length) {
                modalHtml += `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-users fa-3x mb-3 opacity-50"></i>
                        <h5>No Active Sessions</h5>
                        <p>No users are currently active in the system.</p>
                    </div>
                `;
            } else {
                modalHtml += `
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Role</th>
                                    <th>Company</th>
                                    <th>Cart Amount</th>
                                    <th>Cart Items</th>
                                    <th>Last Activity</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                sessions.forEach(session => {
                    let cartAmount = Number(session.cart_amount || 0);
                    const role = (session.role || 'user').toLowerCase();
                    let roleColor = 'secondary';
                    if (role === 'admin') roleColor = 'danger';
                    else if (role === 'company') roleColor = 'primary';

                    modalHtml += `
                        <tr>
                            <td>
                                <strong>${session.username || 'Unknown'}</strong><br>
                                <small class="text-muted">${session.email || ''}</small>
                            </td>
                            <td>
                                <span class="badge bg-${roleColor} text-capitalize">${role}</span>
                            </td>
                            <td>
                                <strong>${session.company_name || 'Not selected'}</strong><br>
                                <small class="text-muted">${session.company_email || ''}</small>
                            </td>
                            <td>
                                <strong>â‚¹${cartAmount.toLocaleString('en-IN', { maximumFractionDigits: 2 })}</strong>
                            </td>
                            <td>
                                <span class="badge bg-info">${session.cart_items_count || 0} items</span>
                            </td>
                            <td>
                                <small>${session.last_activity || ''}</small>
                            </td>
                        </tr>
                    `;
                });

                modalHtml += `
                            </tbody>
                        </table>
                    </div>
                `;
            }

            modalHtml += `
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-primary" onclick="refreshActiveSessions()">Refresh</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            const existingModal = document.getElementById('activeSessionsModal');
            if (existingModal) {
                existingModal.remove();
            }

            document.body.insertAdjacentHTML('beforeend', modalHtml);
            new bootstrap.Modal(document.getElementById('activeSessionsModal')).show();
        }

        function refreshActiveSessions() {
            const modal = bootstrap.Modal.getInstance(document.getElementById('activeSessionsModal'));
            if (modal) {
                modal.hide();
            }
            setTimeout(() => {
                showActiveSessionsModal();
            }, 300);
        }
    </script>
{% endblock %}

{% block content %}
    <div class="container-fluid admin-page dashboard-wrapper">
        <div class="row mb-4">
            <div class="col-12">
                <h2 class="page-title">Admin Dashboard</h2>
                <p class="page-subtitle">Welcome back, {{ user.username }}!</p>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-xl-3 col-md-6 mb-3">
                <div class="card stats-card gradient-royal text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-title text-uppercase mb-1">Total Accounts</h6>
                                <h3 class="mb-0" id="totalAccounts">0</h3>
                                <small class="text-white-50">Companies onboarded</small>
                            </div>
                            <i class="fas fa-building fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-3">
                <div class="card stats-card gradient-emerald text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-title text-uppercase mb-1">Active Sessions</h6>
                                <h3 class="mb-0" id="activeSessions">0</h3>
                                <small class="text-white-50">Live browsers in use</small>
                            </div>
                            <i class="fas fa-user-check fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-3">
                <div class="card stats-card gradient-azure text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-title text-uppercase mb-1">Quotations Issued</h6>
                                <h3 class="mb-0" id="totalQuotations">0</h3>
                                <small class="text-white-50 d-none" id="quotationsOnHoldWrapper">On hold / in cart: <span id="quotationsOnHold">0</span></small>
                            </div>
                            <i class="fas fa-file-invoice fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-3">
                <div class="card stats-card gradient-amber text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-title text-uppercase mb-1">Total Users</h6>
                                <h3 class="mb-0" id="totalUsers">0</h3>
                                <small class="text-dark">Active credentials in system</small>
                            </div>
                            <i class="fas fa-users fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-lg-8 mb-4">
                <div class="card stats-card glass-card">
                    <div class="card-header glass-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-chart-line me-2 text-primary"></i>
                            Users & Quotations Over Time
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="usersChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4 mb-4">
                <div class="card stats-card glass-card">
                    <div class="card-header glass-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-chart-pie me-2 text-success"></i>
                            User Roles Distribution
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="rolesChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-8 mb-4">
                <div class="card stats-card glass-card">
                    <div class="card-header glass-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-clock me-2 text-info"></i>
                            Recent Activity
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="recentActivity">
                            <div class="text-center text-muted">
                                <i class="fas fa-spinner fa-spin me-2"></i>
                                Loading recent activity...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4 mb-4">
                <div class="card stats-card glass-card">
                    <div class="card-header glass-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-bolt me-2 text-warning"></i>
                            Quick Actions
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-premium btn-primary admin-action-btn" data-action="addUser" data-persist-loading="true">
                                <span class="btn-spinner" aria-hidden="true"></span>
                                <i class="fas fa-user-plus"></i>
                                <span class="btn-label">Add New User</span>
                            </button>
                            <button class="btn btn-premium btn-info admin-action-btn" data-action="viewUsers" data-persist-loading="true">
                                <span class="btn-spinner" aria-hidden="true"></span>
                                <i class="fas fa-users"></i>
                                <span class="btn-label">Manage Users</span>
                            </button>
                            <button class="btn btn-premium btn-success admin-action-btn" data-action="viewQuotations" data-persist-loading="true">
                                <span class="btn-spinner" aria-hidden="true"></span>
                                <i class="fas fa-file-invoice"></i>
                                <span class="btn-label">View Quotation History</span>
                            </button>
                            <button class="btn btn-premium btn-warning admin-action-btn" data-action="viewSessions">
                                <span class="btn-spinner" aria-hidden="true"></span>
                                <i class="fas fa-users-cog"></i>
                                <span class="btn-label">Active Sessions</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
