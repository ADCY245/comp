{% extends 'admin/base.html' %}

{% block title %}Admin Dashboard - Product Calculator{% endblock %}

{% block extra_css %}
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/admin-dashboard.css') }}">
{% endblock %}

{% block extra_js %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let usersChart;
        let rolesChart;
        
        // Load dashboard data when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardStats();
            loadChartData();
            initializeActionButtons();
        });

        function initializeActionButtons() {
            const actionHandlers = {
                addUser: () => addNewUser(),
                viewUsers: () => viewAllUsers(),
                viewQuotations: () => viewQuotationHistory(),
                viewSessions: () => showActiveSessionsModal()
            };

            document.querySelectorAll('.admin-action-btn').forEach(button => {
                const action = button.dataset.action;
                if (!action || !actionHandlers[action]) return;

                button.addEventListener('click', async () => {
                    if (button.classList.contains('btn-loading')) return;
                    const persist = button.dataset.persistLoading === 'true';
                    button.classList.add('btn-loading');

                    try {
                        const result = actionHandlers[action]();
                        if (result instanceof Promise) {
                            await result;
                        }
                    } finally {
                        if (!persist) {
                            button.classList.remove('btn-loading');
                        }
                    }
                });
            });
        }
        
        // Load dashboard statistics
        async function loadDashboardStats() {
            try {
                const response = await fetch('/api/admin/stats');
                const data = await response.json();
                
                if (data.error) {
                    console.error('Error loading stats:', data.error);
                    return;
                }
                
                // Update stats cards
                document.getElementById('totalUsers').textContent = data.total_users;
                document.getElementById('activeSessions').textContent = data.active_sessions;
                document.getElementById('totalQuotations').textContent = data.total_quotations;
                
                // Calculate admin users from recent activity
                const adminCount = data.recent_activity.filter(activity => activity.role === 'admin').length;
                document.getElementById('adminUsers').textContent = adminCount;
                
                // Update recent activity
                updateRecentActivity(data.recent_activity);
                
            } catch (error) {
                console.error('Error loading dashboard stats:', error);
                document.getElementById('totalUsers').textContent = 'Error';
                document.getElementById('activeSessions').textContent = 'Error';
            }
        }
        
        // Load chart data
        async function loadChartData() {
            try {
                const response = await fetch('/api/admin/chart-data');
                const data = await response.json();
                
                if (data.error) {
                    console.error('Error loading chart data:', data.error);
                    return;
                }
                
                // Create users chart
                createUsersChart(data.users_by_month);
                
                // Create roles chart
                createRolesChart(data.user_roles);
                
            } catch (error) {
                console.error('Error loading chart data:', error);
            }
        }
        
        // Create users over time chart
        function createUsersChart(data) {
            const ctx = document.getElementById('usersChart').getContext('2d');
            
            usersChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(item => item.month),
                    datasets: [{
                        label: 'New Users',
                        data: data.map(item => item.users),
                        borderColor: '#AD974F',
                        backgroundColor: 'rgba(173, 151, 79, 0.25)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Quotations Sent',
                        data: data.map(item => item.quotations),
                        borderColor: '#8E793E',
                        backgroundColor: 'rgba(142, 121, 62, 0.25)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        // Create user roles pie chart
        function createRolesChart(data) {
            const ctx = document.getElementById('rolesChart').getContext('2d');
            
            rolesChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.map(item => item.role.charAt(0).toUpperCase() + item.role.slice(1)),
                    datasets: [{
                        data: data.map(item => item.count),
                        backgroundColor: [
                            '#AD974F',
                            '#8E793E',
                            '#050A30',
                            '#231F20',
                            '#8B8383',
                            '#EAEAEA'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        // Update recent activity
        function updateRecentActivity(activities) {
            const container = document.getElementById('recentActivity');
            
            if (activities.length === 0) {
                container.innerHTML = '<div class="text-center text-muted">No recent activity</div>';
                return;
            }
            
            const html = activities.map(activity => `
                <div class="activity-item ${activity.role}">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <strong>${activity.message}</strong>
                            <br>
                            <small class="text-muted">${activity.timestamp}</small>
                        </div>
                        <span class="badge bg-${activity.role === 'admin' ? 'danger' : 'success'}">
                            ${activity.role}
                        </span>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }
        
        // Quick Actions - Fully Functional
        function addNewUser() {
            // Redirect to manage users page and trigger add user modal
            window.location.href = '/admin/manage-users?action=add';
        }
        
        function viewAllUsers() {
            // Redirect to manage users page
            window.location.href = '/admin/manage-users';
        }
        
        function viewQuotationHistory() {
            // Redirect to quotations page
            window.location.href = '/admin/quotations';
        }
        
        function viewActiveSessions() {
            // Show active sessions modal
            showActiveSessionsModal();
        }
        
        // Active Sessions Modal
        async function showActiveSessionsModal() {
            try {
                const response = await fetch('/api/admin/active-sessions');
                const data = await response.json();
                
                if (data.error) {
                    alert('Error loading active sessions: ' + data.error);
                    return;
                }
                
                displayActiveSessionsModal(data.sessions);
                
            } catch (error) {
                console.error('Error loading active sessions:', error);
                alert('Error loading active sessions');
            }
        }
        
        function displayActiveSessionsModal(sessions) {
            let modalHtml = `
                <div class="modal fade" id="activeSessionsModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Active User Sessions</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
            `;
            
            if (sessions.length === 0) {
                modalHtml += `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-users fa-3x mb-3 opacity-50"></i>
                        <h5>No Active Sessions</h5>
                        <p>No users are currently active in the system.</p>
                    </div>
                `;
            } else {
                modalHtml += `
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Role</th>
                                    <th>Company</th>
                                    <th>Cart Amount</th>
                                    <th>Cart Items</th>
                                    <th>Last Activity</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                sessions.forEach(session => {
                    // Set role badge color - admin is red, company is blue, default is gray
                    let roleColor = 'secondary';
                    if (session.role === 'admin') {
                        roleColor = 'danger';
                    } else if (session.role === 'company') {
                        roleColor = 'primary';
                    }
                    
                    modalHtml += `
                        <tr>
                            <td>
                                <strong>${session.username}</strong><br>
                                <small class="text-muted">${session.email}</small>
                            </td>
                            <td>
                                <span class="badge bg-${roleColor} text-capitalize">${session.role}</span>
                            </td>
                            <td>
                                <strong>${session.company_name}</strong><br>
                                <small class="text-muted">${session.company_email}</small>
                            </td>
                            <td>
                                <strong>â‚¹${session.cart_amount.toLocaleString('en-IN')}</strong>
                            </td>
                            <td>
                                <span class="badge bg-info">${session.cart_items_count} items</span>
                            </td>
                            <td>
                                <small>${session.last_activity}</small>
                            </td>
                        </tr>
                    `;
                });
                
                modalHtml += `
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            modalHtml += `
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-primary" onclick="refreshActiveSessions()">Refresh</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('activeSessionsModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add new modal to body
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Show modal
            new bootstrap.Modal(document.getElementById('activeSessionsModal')).show();
        }
        
        function refreshActiveSessions() {
            const modal = bootstrap.Modal.getInstance(document.getElementById('activeSessionsModal'));
            modal.hide();
            setTimeout(() => {
                showActiveSessionsModal();
            }, 300);
        }
    </script>
{% endblock %}

{% block content %}
    <div class="dashboard-wrapper container-xxl px-4 py-4">
        <div class="row mb-4">
            <div class="col-12">
                <h2 class="page-title">Admin Dashboard</h2>
                <p class="page-subtitle">Welcome back, {{ user.username }}!</p>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="row mb-4">
            <div class="col-xl-3 col-md-6 mb-3">
                <div class="card stats-card gradient-royal text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-title text-uppercase mb-1">Total Users</h6>
                                <h3 class="mb-0" id="totalUsers">Loading...</h3>
                            </div>
                            <div>
                                <i class="fas fa-users fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-xl-3 col-md-6 mb-3">
                <div class="card stats-card gradient-emerald text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-title text-uppercase mb-1">Active Sessions</h6>
                                <h3 class="mb-0" id="activeSessions">0</h3>
                            </div>
                            <div>
                                <i class="fas fa-user-check fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-xl-3 col-md-6 mb-3">
                <div class="card stats-card gradient-azure text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-title text-uppercase mb-1">Total Quotations</h6>
                                <h3 class="mb-0" id="totalQuotations">0</h3>
                            </div>
                            <div>
                                <i class="fas fa-file-invoice fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-xl-3 col-md-6 mb-3">
                <div class="card stats-card gradient-amber text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-title text-uppercase mb-1">Admin Users</h6>
                                <h3 class="mb-0" id="adminUsers">0</h3>
                            </div>
                            <div>
                                <i class="fas fa-user-shield fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row mb-4">
            <div class="col-lg-8 mb-4">
                <div class="card stats-card glass-card">
                    <div class="card-header glass-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-chart-line me-2 text-primary"></i>
                            Users & Quotations Over Time
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="usersChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4 mb-4">
                <div class="card stats-card glass-card">
                    <div class="card-header glass-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-chart-pie me-2 text-success"></i>
                            User Roles Distribution
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="rolesChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity & Quick Actions -->
        <div class="row">
            <div class="col-lg-8 mb-4">
                <div class="card stats-card glass-card">
                    <div class="card-header glass-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-clock me-2 text-info"></i>
                            Recent Activity
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="recentActivity">
                            <div class="text-center text-muted">
                                <i class="fas fa-spinner fa-spin me-2"></i>
                                Loading recent activity...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4 mb-4">
                <div class="card stats-card glass-card">
                    <div class="card-header glass-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-bolt me-2 text-warning"></i>
                            Quick Actions
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-premium btn-primary admin-action-btn" data-action="addUser" data-persist-loading="true">
                                <span class="btn-spinner" aria-hidden="true"></span>
                                <i class="fas fa-user-plus"></i>
                                <span class="btn-label">Add New User</span>
                            </button>
                            <button class="btn btn-premium btn-info admin-action-btn" data-action="viewUsers" data-persist-loading="true">
                                <span class="btn-spinner" aria-hidden="true"></span>
                                <i class="fas fa-users"></i>
                                <span class="btn-label">Manage Users</span>
                            </button>
                            <button class="btn btn-premium btn-success admin-action-btn" data-action="viewQuotations" data-persist-loading="true">
                                <span class="btn-spinner" aria-hidden="true"></span>
                                <i class="fas fa-file-invoice"></i>
                                <span class="btn-label">View Quotation History</span>
                            </button>
                            <button class="btn btn-premium btn-warning admin-action-btn" data-action="viewSessions">
                                <span class="btn-spinner" aria-hidden="true"></span>
                                <i class="fas fa-users-cog"></i>
                                <span class="btn-label">Active Sessions</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
