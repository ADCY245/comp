<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Users - Admin Panel</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- DataTables CSS -->
    <link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/admin-manage-users.css') }}">
</head>
<body>
    <!-- Admin Navigation -->
    <nav class="navbar navbar-expand-lg admin-navbar">
        <div class="container-fluid">
            <a class="navbar-brand" href="{{ url_for('admin_dashboard') }}">
                <i class="fas fa-calculator me-2"></i>
                Product Calculator
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#adminNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="adminNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('admin_dashboard') }}">
                            <i class="fas fa-tachometer-alt me-1"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="#">
                            <i class="fas fa-users me-1"></i> Manage Users
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/quotations">
                            <i class="fas fa-file-invoice me-1"></i> Check Quotations
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/">
                            <i class="fas fa-home me-1"></i> Users Page
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/dealer/index.html">
                            <i class="fas fa-store me-1"></i> Dealers Page
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/api/auth/logout">
                            <i class="fas fa-sign-out-alt me-1"></i> Logout
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Page Header -->
        <div class="row mb-4">
            <div class="col-12">
                <h2 class="text-dark mb-0">Manage Users</h2>
                <p class="text-muted">Add, edit, and manage user accounts and roles</p>
            </div>
        </div>

        <!-- Users Management Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-users me-2"></i>
                                User Management
                            </h5>
                            <button class="btn btn-light btn-sm" onclick="showAddUserModal()">
                                <i class="fas fa-user-plus me-1"></i> Add New User
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table id="usersTable" class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Username</th>
                                        <th>Email</th>
                                        <th>Role</th>
                                        <th>Assigned Companies</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                    <!-- Users will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Companies Management Section -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-building me-2"></i>
                                Company Management
                            </h5>
                            <div>
                                <button class="btn btn-light btn-sm me-2" onclick="showAddCompanyModal()">
                                    <i class="fas fa-plus me-1"></i> Add Company
                                </button>
                                <button class="btn btn-outline-light btn-sm" onclick="showAllCompanies()">
                                    <i class="fas fa-list me-1"></i> View All
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Search Bar -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="input-group">
                                    <input type="text" class="form-control" id="companySearch" placeholder="Search companies...">
                                    <button class="btn btn-outline-secondary" type="button" onclick="searchCompanies()">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Companies List -->
                        <div id="companiesList">
                            <!-- Companies will be loaded here -->
                        </div>
                        
                        <!-- Load More Button -->
                        <div class="text-center mt-3">
                            <button class="btn btn-outline-primary" id="loadMoreCompanies" onclick="loadMoreCompanies()">
                                <i class="fas fa-chevron-down me-1"></i> Load More Companies
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Modal -->
    <div class="modal fade" id="userModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="userModalTitle">Add New User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="userForm">
                        <input type="hidden" id="userId">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="username" class="form-label">Username <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="username" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="email" class="form-label">Email <span class="text-danger">*</span></label>
                                    <input type="email" class="form-control" id="email" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="password" class="form-label">Password <span class="text-danger">*</span></label>
                                    <input type="password" class="form-control" id="password" required>
                                    <small id="passwordHelp" class="form-text text-muted">Leave empty to keep current password when editing</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="role" class="form-label">Role <span class="text-danger">*</span></label>
                                    <select class="form-select" id="role" required onchange="toggleAssignmentSections()">
                                        <option value="">Select Role</option>
                                        <option value="admin">Admin</option>
                                        <option value="user">User</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div id="customerAssignmentSection" class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="form-label mb-0">Assign Customers</label>
                                <div>
                                    <button type="button" class="btn btn-sm btn-outline-secondary me-1" onclick="document.querySelectorAll('.customer-checkbox').forEach(cb => cb.checked = true)">
                                        Select All
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="document.querySelectorAll('.customer-checkbox').forEach(cb => cb.checked = false)">
                                        Clear All
                                    </button>
                                </div>
                            </div>
                            <div id="customerCheckboxList" class="border p-3 rounded" style="max-height: 300px; overflow-y: auto; background-color: #f8f9fa;">
                                <div id="customerLoading" class="text-center py-3">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2 mb-0">Loading customers...</p>
                                </div>
                                <!-- Customer checkboxes will be inserted here -->
                            </div>
                            <small class="text-muted">Select which customers this user can access. Admins have access to all customers.</small>
                        </div>

                        <div id="companyAssignmentSection" class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="form-label mb-0">Assign Companies</label>
                                <div>
                                    <button type="button" class="btn btn-sm btn-outline-secondary me-1" onclick="document.querySelectorAll('.company-checkbox').forEach(cb => cb.checked = true)">
                                        Select All
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="document.querySelectorAll('.company-checkbox').forEach(cb => cb.checked = false)">
                                        Clear All
                                    </button>
                                </div>
                            </div>
                            <div id="companyCheckboxList" class="border p-3 rounded" style="max-height: 300px; overflow-y: auto; background-color: #f8f9fa;">
                                <div id="companyLoading" class="text-center py-3">
                                    <div class="spinner-border text-success" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2 mb-0">Loading companies...</p>
                                </div>
                                <!-- Company checkboxes will be inserted here -->
                            </div>
                            <small class="text-muted">Choose the companies this user should have access to. Admins automatically see all companies.</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i> Cancel
                    </button>
                    <button type="button" class="btn btn-primary" id="saveUserBtn" onclick="saveUser()">
                        <i class="fas fa-save me-1"></i> Save User
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Company Modal -->
    <div class="modal fade" id="companyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="companyModalTitle">Add New Company</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="companyForm">
                        <input type="hidden" id="companyId" name="companyId">
                        <div class="mb-3">
                            <label for="companyName" class="form-label">Company Name</label>
                            <input type="text" class="form-control" id="companyName" name="companyName" required>
                        </div>
                        <div class="mb-3">
                            <label for="companyEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="companyEmail" name="companyEmail" required>
                        </div>
                        <div class="mb-3">
                            <label for="companyAddress" class="form-label">Address</label>
                            <textarea class="form-control" id="companyAddress" name="companyAddress" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="companyAssignedTo" class="form-label">Customer Assigned To</label>
                            <select class="form-select" id="companyAssignedTo" name="companyAssignedTo" multiple>
                                <!-- Users will be loaded dynamically -->
                            </select>
                            <small class="text-muted">Select one or more users to assign this company's customers.</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="saveCompany()">Save Company</button>
                </div>
            </div>
        </div>
    </div>

    <!-- jQuery (required by DataTables) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let allUsers = [];
        // Global variables
        let allCustomers = [];
        let currentUser = null;
        let currentPage = 0;
        const pageSize = 10;
        let hasMoreCompanies = true;
        let isSearching = false;
        let currentSearchTerm = '';
        
        // Table instances
        let usersTable = null;
        let companiesTable = null;
        let customersTable = null;
        let allCompaniesForAssignment = [];

        
        // Constants
        const companiesPerPage = 10;
        
        async function populateCompanyAssignedTo(selectedUserIds = []) {
            const select = document.getElementById('companyAssignedTo');
            if (!select) return;

            const selectedIdsString = Array.isArray(selectedUserIds)
                ? selectedUserIds.map(String)
                : [];

            try {
                if (!Array.isArray(allUsers) || allUsers.length === 0) {
                    const response = await fetch('/api/admin/users');
                    const data = await response.json();
                    if (data.success) {
                        allUsers = Array.isArray(data.users) ? data.users : [];
                    } else {
                        console.error('Failed to load users for company assignment:', data.error);
                        return;
                    }
                }

                select.innerHTML = '';

                const sortedUsers = [...allUsers].sort((a, b) => {
                    const nameA = (a.username || a.email || '').toLowerCase();
                    const nameB = (b.username || b.email || '').toLowerCase();
                    if (nameA < nameB) return -1;
                    if (nameA > nameB) return 1;
                    return 0;
                });

                sortedUsers.forEach(user => {
                    const value = String(user._id || user.id || '');
                    if (!value) return;
                    const label = user.username || user.email || value;
                    const option = document.createElement('option');
                    option.value = value;
                    option.textContent = label;
                    if (selectedIdsString.includes(option.value)) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error populating company assignment list:', error);
            }
        }

        $(document).ready(function() {
            try {
                // Initialize DataTables with error handling
                usersTable = $('#usersTable').DataTable({
                    responsive: true,
                    order: [[4, 'desc']],  // Sort by Created date by default
                    columnDefs: [
                        { orderable: false, targets: [5] },  // Actions column
                        { width: '15%', targets: [0] },      // Username
                        { width: '25%', targets: [1] },      // Email
                        { width: '10%', targets: [2] },      // Role
                        { width: '15%', targets: [3] },      // Assigned Companies
                        { width: '15%', targets: [4] },      // Created
                        { width: '20%', targets: [5] }       // Actions
                    ],
                    // Add error handling
                    error: function(settings, techNote, message) {
                        console.error('DataTables error:', message);
                    },
                    // Disable automatic width calculation
                    autoWidth: false,
                    // Enable horizontal scrolling if needed
                    scrollX: true
                });

                // Initialize other tables if they exist
                if ($('#companiesTable').length) {
                    companiesTable = $('#companiesTable').DataTable({
                        responsive: true,
                        // Add your companies table config
                    });
                }
                
                if ($('#customersTable').length) {
                    customersTable = $('#customersTable').DataTable({
                        responsive: true,
                        // Add your customers table config
                    });
                }

                // Load initial data
                loadUsers();
                loadCompanies();
                loadAllCustomers();
                loadAllCompaniesForAssignment();
            } catch (error) {
                console.error('Error initializing page:', error);
            }
        });
        
        // Load users data
        function loadUsers() {
            fetch('/api/admin/users')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        allUsers = Array.isArray(data.users) ? data.users : [];
                        populateUsersTable(data.users);
                        // Refresh company assignment select if modal is open
                        populateCompanyAssignedTo();
                    } else {
                        console.error('Failed to load users:', data.error);
                        alert('Failed to load users. Please try again.');
                    }
                })
                .catch(error => {
                    console.error('Error loading users:', error);
                    alert('Error loading users. Please check console for details.');
                });
        }
        
        // Populate users table
        function populateUsersTable(users) {
            const tbody = document.getElementById('usersTableBody');
            if (!tbody) return;
            
            // Clear existing rows using DataTables API if available
            if ($.fn.DataTable.isDataTable('#usersTable') && usersTable) {
                usersTable.clear().draw();
            } else {
                tbody.innerHTML = '';
            }
            
            // If no users, show message
            if (!users || users.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = '<td colspan="6" class="text-center">No users found</td>';
                tbody.appendChild(tr);
                return;
            }
            
            // Prepare data for DataTables
            const rows = users.map(user => {
                // Format created date
                const createdDate = new Date(user.created_at);
                const formattedDate = createdDate.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                
                // Create action buttons
                const actions = `
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-sm btn-primary" onclick="editUser('${user._id || user.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-danger" onclick="deleteUser('${user._id || user.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                const assignedCompanyCount = Array.isArray(user.assigned_companies) ? user.assigned_companies.length : 0;

                return [
                    user.username || '-',
                    user.email || '-',
                    `<span class="badge bg-${getRoleBadgeColor(user.role)}">${user.role || 'user'}</span>`,
                    assignedCompanyCount,
                    formattedDate,
                    actions
                ];
            });
            
            // Add rows to DataTable or directly to tbody
            if ($.fn.DataTable.isDataTable('#usersTable') && usersTable) {
                usersTable.rows.add(rows).draw();
            } else {
                // Fallback if DataTables is not initialized
                rows.forEach(rowData => {
                    const tr = document.createElement('tr');
                    rowData.forEach((cellData, index) => {
                        const td = document.createElement('td');
                        if (index === 5) { // Actions column
                            td.className = 'text-nowrap';
                        }
                        td.innerHTML = cellData;
                        tr.appendChild(td);
                    });
                    tbody.appendChild(tr);
                });
            }
        }
        
        // Load companies data
        async function loadCompanies(page = 0) {
            try {
                const response = await fetch(`/api/admin/companies?page=${page}&limit=${companiesPerPage}`);
                const data = await response.json();
                
                if (data.error) {
                    console.error('Error loading companies:', data.error);
                    return;
                }
                
                if (page === 0) {
                    populateCompaniesList(data.companies);
                } else {
                    appendCompaniesList(data.companies);
                }
                
                // Show/hide load more button
                const loadMoreBtn = document.getElementById('loadMoreCompanies');
                if (data.companies.length < companiesPerPage) {
                    loadMoreBtn.style.display = 'none';
                } else {
                    loadMoreBtn.style.display = 'block';
                }
                
            } catch (error) {
                console.error('Error loading companies:', error);
            }
        }
        
        // Populate companies list
        function populateCompaniesList(companies) {
            const container = document.getElementById('companiesList');
            container.innerHTML = '';
            
            companies.forEach(company => {
                const item = createCompanyItem(company);
                container.appendChild(item);
            });
        }
        
        // Append companies to list
        function appendCompaniesList(companies) {
            const container = document.getElementById('companiesList');
            
            companies.forEach(company => {
                const item = createCompanyItem(company);
                container.appendChild(item);
            });
        }
        
        // Create company item element
        function createCompanyItem(company) {
            const item = document.createElement('div');
            item.className = 'company-item';
            item.innerHTML = `
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="mb-1">${company.name}</h6>
                        <p class="mb-1 text-muted">${company.email}</p>
                        <small class="text-muted">${company.address || 'No address provided'}</small>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-primary btn-action" onclick="editCompany('${company.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger btn-action" onclick="deleteCompany('${company.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            return item;
        }
        
        async function loadAllCompaniesForAssignment(selectedCompanyIds = []) {
            const loadingIndicator = document.getElementById('companyLoading');
            const companyList = document.getElementById('companyCheckboxList');

            if (!companyList) return;

            if (loadingIndicator) {
                loadingIndicator.style.display = 'block';
            }

            try {
                if (!Array.isArray(allCompaniesForAssignment) || allCompaniesForAssignment.length === 0) {
                    const response = await fetch('/api/admin/companies?page=0&limit=1000');
                    const data = await response.json();

                    if (data.success) {
                        allCompaniesForAssignment = data.companies || [];
                    } else {
                        throw new Error(data.error || 'Failed to load companies');
                    }
                }

                companyList.innerHTML = '';

                if (!Array.isArray(allCompaniesForAssignment) || allCompaniesForAssignment.length === 0) {
                    companyList.innerHTML = '<div class="alert alert-info mb-0">No companies available. Please add companies first.</div>';
                    return;
                }

                const selectedSet = new Set((selectedCompanyIds || []).map(String));

                allCompaniesForAssignment.forEach(company => {
                    const companyId = String(company.id || company._id || '');
                    if (!companyId) return;

                    const wrapper = document.createElement('div');
                    wrapper.className = 'form-check mb-2';
                    wrapper.innerHTML = `
                        <input class="form-check-input company-checkbox" type="checkbox" value="${companyId}" id="assign-company-${companyId}" ${selectedSet.has(companyId) ? 'checked' : ''}>
                        <label class="form-check-label" for="assign-company-${companyId}">
                            ${company.name || 'Unnamed Company'}
                            ${company.email ? `<small class="text-muted d-block">${company.email}</small>` : ''}
                        </label>
                    `;
                    companyList.appendChild(wrapper);
                });
            } catch (error) {
                console.error('Error loading companies for assignment:', error);
                companyList.innerHTML = `<div class="alert alert-danger">${error.message || 'Failed to load companies.'}</div>`;
            } finally {
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'none';
                }
            }
        }

        // Helper functions
        function getRoleBadgeColor(role) {
            switch(role) {
                case 'admin': return 'danger';
                case 'dealer': return 'warning';
                default: return 'success';
            }
        }
        
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            return new Date(dateString).toLocaleDateString();
        }

        // Render customer checkboxes in the user modal
        function renderCustomerCheckboxes(customers = [], selectedCustomerIds = []) {
            const container = document.getElementById('customerCheckboxList');
            if (!container) return;
            
            // Clear any existing content except the loading indicator
            container.innerHTML = '';
            
            // If no customers provided, show message
            if (!customers || customers.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        No customers found. Please add customers first.
                    </div>`;
                return;
            }
            
            // Create a document fragment for better performance
            const fragment = document.createDocumentFragment();
            
            // Group customers by first letter for better organization
            const customersByLetter = {};
            customers.forEach(customer => {
                const customerName = customer.name || customer.companyName || `Customer ${customer._id || customer.id}`;
                const firstLetter = customerName.charAt(0).toUpperCase();
                if (!customersByLetter[firstLetter]) {
                    customersByLetter[firstLetter] = [];
                }
                customersByLetter[firstLetter].push({
                    ...customer,
                    displayName: customerName
                });
            });
            
            // Sort letters
            const sortedLetters = Object.keys(customersByLetter).sort();
            
            // Create search box
            const searchBox = document.createElement('div');
            searchBox.className = 'mb-3 sticky-top bg-white py-2';
            searchBox.style.zIndex = '1';
            searchBox.innerHTML = `
                <div class="input-group input-group-sm">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" id="customerSearch" class="form-control" 
                           placeholder="Search customers..." 
                           onkeyup="filterCustomers(this.value)">
                    <button class="btn btn-outline-secondary" type="button" 
                            onclick="document.getElementById('customerSearch').value = ''; filterCustomers('')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>`;
            fragment.appendChild(searchBox);
            
            // Create customer list container
            const listContainer = document.createElement('div');
            listContainer.id = 'customerListContainer';
            listContainer.style.maxHeight = '250px';
            listContainer.style.overflowY = 'auto';
            
            // Add customers grouped by first letter
            sortedLetters.forEach(letter => {
                const letterGroup = document.createElement('div');
                letterGroup.className = 'mb-2';
                
                // Add letter header
                const header = document.createElement('div');
                header.className = 'fw-bold text-muted small mb-1';
                header.textContent = letter;
                letterGroup.appendChild(header);
                
                // Add customers for this letter
                customersByLetter[letter].forEach(customer => {
                    const customerId = String(customer._id || customer.id);
                    const isChecked = Array.isArray(selectedCustomerIds) && 
                                    selectedCustomerIds.includes(customerId);
                    
                    const checkboxDiv = document.createElement('div');
                    checkboxDiv.className = 'form-check ms-2 mb-1';
                    checkboxDiv.innerHTML = `
                        <input class="form-check-input customer-checkbox" 
                               type="checkbox" 
                               value="${customerId}" 
                               id="customer-${customerId}" 
                               ${isChecked ? 'checked' : ''}>
                        <label class="form-check-label" for="customer-${customerId}">
                            ${customer.displayName}
                            ${customer.email ? `<small class="text-muted d-block">${customer.email}</small>` : ''}
                        </label>
                    `;
                    letterGroup.appendChild(checkboxDiv);
                });
                
                listContainer.appendChild(letterGroup);
            });
            
            fragment.appendChild(listContainer);
            container.appendChild(fragment);
            
            // Scroll to first selected customer if any
            const firstSelected = container.querySelector('.customer-checkbox:checked');
            if (firstSelected) {
                firstSelected.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
        
        // Filter customers in the list
        function filterCustomers(searchTerm) {
            const search = searchTerm.toLowerCase().trim();
            const container = document.getElementById('customerListContainer');
            if (!container) return;
            
            const customerItems = Array.from(container.children);
            
            if (!search) {
                // Show all customers if search is empty
                customerItems.forEach(item => item.style.display = '');
                const noResults = document.getElementById('noResultsMessage');
                if (noResults) noResults.remove();
                return;
            }
            
            let hasVisibleItems = false;
            
            customerItems.forEach(letterGroup => {
                const checkboxes = letterGroup.querySelectorAll('.form-check');
                let hasVisibleInGroup = false;
                
                checkboxes.forEach(checkbox => {
                    const label = checkbox.querySelector('label');
                    if (label) {
                        const text = label.textContent.toLowerCase();
                        const isVisible = text.includes(search);
                        checkbox.style.display = isVisible ? '' : 'none';
                        if (isVisible) hasVisibleInGroup = true;
                    }
                });
                
                // Show/hide letter group header based on visibility
                const header = letterGroup.querySelector('.fw-bold');
                if (header) {
                    header.style.display = hasVisibleInGroup ? '' : 'none';
                }
                
                if (hasVisibleInGroup) hasVisibleItems = true;
            });
            
            // Show message if no results
            const noResults = document.getElementById('noResultsMessage');
            if (!hasVisibleItems) {
                if (!noResults) {
                    const message = document.createElement('div');
                    message.id = 'noResultsMessage';
                    message.className = 'alert alert-warning mb-0';
                    message.innerHTML = '<i class="fas fa-search me-2"></i>No customers match your search.';
                    container.prepend(message);
                }
            } else if (noResults) {
                noResults.remove();
            }
        }

        // Toggle assignment sections based on role
        function toggleAssignmentSections() {
            const roleSelect = document.getElementById('role');
            const customerSection = document.getElementById('customerAssignmentSection');
            const companySection = document.getElementById('companyAssignmentSection');
            
            if (roleSelect) {
                const isAdmin = roleSelect.value === 'admin';
                if (customerSection) {
                    customerSection.style.display = isAdmin ? 'none' : 'block';
                }
                if (companySection) {
                    companySection.style.display = isAdmin ? 'none' : 'block';
                }
                
                // If showing the section and customers aren't loaded yet, load them
                if (!isAdmin && (!window.allCustomers || window.allCustomers.length === 0)) {
                    loadAllCustomers();
                }
                
                if (!isAdmin && allCompaniesForAssignment.length === 0) {
                    loadAllCompaniesForAssignment();
                }
            }
        }

        // Get selected customer IDs from checkboxes
        function getSelectedCustomerIds() {
            const checkboxes = document.querySelectorAll('#customerCheckboxList .customer-checkbox:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        // Show add user modal
        function showAddUserModal() {
            const modal = new bootstrap.Modal(document.getElementById('userModal'));
            document.getElementById('userModalTitle').textContent = 'Add New User';
            document.getElementById('userForm').reset();
            document.getElementById('userId').value = '';
            document.getElementById('password').required = true;
            document.getElementById('role').value = 'user';
            
            // Load customers for assignment
            loadAllCustomers();
            loadAllCompaniesForAssignment();
            
            // Show customer assignment section
            document.getElementById('customerAssignmentSection').classList.remove('d-none');
            document.getElementById('companyAssignmentSection').classList.remove('d-none');
            toggleAssignmentSections();
            
            modal.show();
        }
        
        async function showAddCompanyModal() {
            document.getElementById('companyModalTitle').textContent = 'Add New Company';
            document.getElementById('companyForm').reset();
            document.getElementById('companyId').value = '';
            await populateCompanyAssignedTo();
            const select = document.getElementById('companyAssignedTo');
            if (select) Array.from(select.options).forEach(opt => opt.selected = false);
            new bootstrap.Modal(document.getElementById('companyModal')).show();
        }
        
        // CRUD operations
        function saveUser() {
            const userId = document.getElementById('userId').value;
            const username = document.getElementById('username').value.trim();
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const role = document.getElementById('role').value;
            
            if (!username || !email || !role) {
                alert('Please fill in all required fields');
                return;
            }
            
            const userData = {
                username,
                email,
                role,
                customers: getSelectedCustomerIds(),
                assigned_companies: getSelectedCompanyIds()
            };
            
            // Only include password if it's not empty (for updates)
            if (password) {
                userData.password = password;
            }
            
            const method = userId ? 'PUT' : 'POST';
            const url = userId ? `/api/admin/users/${userId}` : '/api/admin/users';
            
            // Show loading state
            const saveBtn = document.getElementById('saveUserBtn');
            const originalBtnText = saveBtn.innerHTML;
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span> Saving...';
            
            fetch(url, {
                method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(userData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast(userId ? 'User updated successfully' : 'User created successfully', 'success');
                    loadUsers();
                    bootstrap.Modal.getInstance(document.getElementById('userModal')).hide();
                } else {
                    throw new Error(data.error || 'Failed to save user');
                }
            })
            .catch(error => {
                console.error('Error saving user:', error);
                showToast(`Error: ${error.message}`, 'danger');
            })
            .finally(() => {
                saveBtn.disabled = false;
                saveBtn.innerHTML = originalBtnText;
            });
        }

        // Show toast notification
        function showToast(message, type = 'info') {
            let toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toastContainer';
                toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
                toastContainer.setAttribute('aria-live', 'polite');
                toastContainer.setAttribute('aria-atomic', 'true');
                document.body.appendChild(toastContainer);
            }
            const toastId = 'toast-' + Date.now();
            const toastHtml = `
                <div id="${toastId}" class="toast align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;
            
            try {
                toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            } catch (err) {
                console.error('Failed to render toast', err, message);
                return;
            }
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement, { autohide: true, delay: 5000 });
            toast.show();
            
            // Remove toast after it's hidden
            toastElement.addEventListener('hidden.bs.toast', function () {
                toastElement.remove();
            });
        }

        function editUser(userId) {
            fetch(`/api/admin/users/${userId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const user = data.user;
                        document.getElementById('userModalTitle').textContent = 'Edit User';
                        document.getElementById('userId').value = user.id;
                        document.getElementById('username').value = user.username;
                        document.getElementById('email').value = user.email;
                        document.getElementById('role').value = user.role;
                        document.getElementById('password').required = false;
                        
                        // Toggle assignment sections based on role
                        toggleAssignmentSections();
                        
                        // Load customers and select the assigned ones
                        loadAllCustomers(user.customers || []);
                        loadAllCompaniesForAssignment(user.assigned_companies || []);

                        const modal = new bootstrap.Modal(document.getElementById('userModal'));
                        modal.show();
                    } else {
                        throw new Error(data.error || 'Failed to load user data');
                    }
                })
                .catch(error => {
                    console.error('Error loading user data:', error);
                    showToast(`Error: ${error.message}`, 'danger');
                });
        }
        
        async function deleteUser(userId) {
            if (confirm('Are you sure you want to delete this user?')) {
                try {
                    const response = await fetch(`/api/admin/users/${userId}`, {
                        method: 'DELETE'
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        loadUsers();
                        alert('User deleted successfully!');
                    } else {
                        alert('Error deleting user: ' + result.error);
                    }
                    
                } catch (error) {
                    console.error('Error deleting user:', error);
                    alert('Error deleting user');
                }
            }
        }
        
        // Company functions
        async function saveCompany() {
            const form = document.getElementById('companyForm');
            const formData = new FormData(form);
            const companyData = Object.fromEntries(formData);
            // Collect assigned users from multi-select
            const assignedSelect = document.getElementById('companyAssignedTo');
            if (assignedSelect) {
                companyData.assigned_to = Array.from(assignedSelect.selectedOptions).map(o => o.value);
            }
            
            try {
                const url = companyData.companyId ? `/api/admin/companies/${companyData.companyId}` : '/api/admin/companies';
                const method = companyData.companyId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(companyData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    bootstrap.Modal.getInstance(document.getElementById('companyModal')).hide();
                    loadCompanies();
                    alert('Company saved successfully!');
                } else {
                    alert('Error saving company: ' + result.error);
                }
                
            } catch (error) {
                console.error('Error saving company:', error);
                alert('Error saving company');
            }
        }
        
        async function editCompany(companyId) {
            try {
                const response = await fetch(`/api/admin/companies/${companyId}`);
                const data = await response.json();
                
                if (data.success) {
                    const company = data.company;
                    document.getElementById('companyModalTitle').textContent = 'Edit Company';
                    document.getElementById('companyId').value = company.id;
                    document.getElementById('companyName').value = company.name;
                    document.getElementById('companyEmail').value = company.email;
                    document.getElementById('companyAddress').value = company.address || '';

                    // Populate and preselect assigned users if provided
                    await populateCompanyAssignedTo(company.assigned_to || []);
                    const select = document.getElementById('companyAssignedTo');
                    const assigned = (company.assigned_to || []).map(String);
                    if (select) {
                        Array.from(select.options).forEach(opt => {
                            opt.selected = assigned.includes(opt.value);
                        });
                    }
                    
                    new bootstrap.Modal(document.getElementById('companyModal')).show();
                }
                
            } catch (error) {
                console.error('Error loading company:', error);
            }
        }
        
        async function deleteCompany(companyId) {
            if (confirm('Are you sure you want to delete this company?')) {
                try {
                    const response = await fetch(`/api/admin/companies/${companyId}`, {
                        method: 'DELETE'
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        loadCompanies();
                        alert('Company deleted successfully!');
                    } else {
                        alert('Error deleting company: ' + result.error);
                    }
                    
                } catch (error) {
                    console.error('Error deleting company:', error);
                    alert('Error deleting company');
                }
            }
        }
        
        // Load all customers for assignment
        async function loadAllCustomers(selectedCustomerIds = []) {
            const loadingIndicator = document.getElementById('customerLoading');
            const customerList = document.getElementById('customerCheckboxList');

            if (!customerList) return;

            try {
                // Show loading state
                if (loadingIndicator) loadingIndicator.style.display = 'block';
                if (customerList) customerList.style.display = 'none';
                
                // Make sure we're using the correct API endpoint
                const response = await fetch('/api/customers', {
                    headers: {
                        'Accept': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                // Hide loading indicator
                if (loadingIndicator) loadingIndicator.style.display = 'none';
                if (customerList) customerList.style.display = 'block';
                
                // Handle different response formats
                let customers = [];
                if (Array.isArray(data)) {
                    customers = data;
                } else if (data && (data.data || data.customers)) {
                    customers = data.data || data.customers || [];
                }
                
                // Store customers globally for filtering
                window.allCustomers = customers;
                
                // Render the checkboxes
                renderCustomerCheckboxes(customers, selectedCustomerIds);
                
                return customers;
                
            } catch (error) {
                console.error('Failed to load customers:', error);
                
                // Update UI to show error state
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'none';
                }
                
                if (customerList) {
                    customerList.innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Failed to load customers. ${error.message || 'Please try again later.'}
                        </div>`;
                    customerList.style.display = 'block';
                }
                
                // Fallback to empty array
                window.allCustomers = [];
                showToast('Error loading customers. Please check console for details.', 'danger');
                return [];
            }
        }

        // Search and pagination
        async function searchCompanies() {
            const query = document.getElementById('companySearch').value;
            try {
                const response = await fetch(`/api/admin/companies/search?q=${encodeURIComponent(query)}`);
                const data = await response.json();
                
                if (data.success) {
                    populateCompaniesList(data.companies);
                    document.getElementById('loadMoreCompanies').style.display = 'none';
                }
                
            } catch (error) {
                console.error('Error searching companies:', error);
            }
        }
        
        function loadMoreCompanies() {
            currentCompanyPage++;
            loadCompanies(currentCompanyPage);
        }
        
        function showAllCompanies() {
            window.open('/admin/companies/all', '_blank');
        }
    </script>
</body>
</html>
