{% extends 'admin/base.html' %}

{% block title %}Manage Users - Admin Panel{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/admin-manage-users.css') }}">
{% endblock %}

{% block content %}
    <div class="container-fluid admin-page">
        <!-- Page Header -->
        <div class="row mb-4 text-white">
            <div class="col-12">
                <h2 class="admin-heading mb-1">Manage Users</h2>
                <p class="admin-subheading">Add, edit, and manage user accounts and roles</p>
            </div>
        </div>

        <!-- Users Management Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card admin-card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center gap-2">
                                <span class="admin-badge gold"><i class="fas fa-users"></i> User Management</span>
                                <h5 class="mb-0 text-white">Overview</h5>
                            </div>
                            <button class="btn admin-btn btn-sm" onclick="showAddUserModal()">
                                <i class="fas fa-user-plus me-1"></i>
                                Add New User
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table id="usersTable" class="table table-striped table-hover admin-table">
                                <thead>
                                    <tr>
                                        <th>Username</th>
                                        <th>Email</th>
                                        <th>Role</th>
                                        <th>Assigned Companies</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                    <!-- Users will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Companies Management Section -->
        <div class="row">
            <div class="col-12">
                <div class="card admin-card">
                    <div class="card-header">
                        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-2">
                            <div class="d-flex align-items-center gap-2">
                                <span class="admin-badge copper"><i class="fas fa-building"></i> Company Management</span>
                                <h5 class="mb-0 text-white">Assignments</h5>
                            </div>
                            <div class="d-flex flex-column align-items-md-end gap-2 w-100 w-md-auto">
                                <div class="d-flex align-items-center flex-wrap justify-content-md-end gap-2">
                                    <div class="filter-dropdown" id="salespersonFilterDropdown">
                                        <button type="button" class="btn filter-dropdown-btn" id="salespersonFilterButton">
                                            <span><i class="fas fa-filter me-1"></i> Filter by</span>
                                            <span id="salespersonFilterLabel">All Users</span>
                                        </button>
                                        <div class="filter-dropdown-menu" id="salespersonFilterMenu">
                                            <button type="button" class="filter-option" data-user-id="" data-user-name="All Users">
                                                <span>All Users</span>
                                                <span class="badge bg-secondary">0</span>
                                            </button>
                                        </div>
                                    </div>
                                    <button class="btn admin-btn btn-sm" onclick="showAddCompanyModal()">
                                        <i class="fas fa-plus me-1"></i> Add Company
                                    </button>
                                    <input type="file" id="companyImportInput" accept=".xlsx,.xlsm" class="d-none" aria-hidden="true">
                                    <button class="btn admin-btn btn-sm" onclick="triggerCompanyImport()">
                                        <i class="fas fa-download me-1"></i> Import
                                    </button>
                                    <button class="btn admin-btn btn-sm" onclick="exportCompanies()">
                                        <i class="fas fa-upload me-1"></i> Export
                                    </button>
                                </div>
                                <span class="filter-dropdown-label text-md-end">Hover to choose a user and filter assigned companies</span>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Search Bar -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="input-group">
                                    <input type="text" class="form-control" id="companySearch" placeholder="Search companies...">
                                    <button class="btn btn-outline-secondary" type="button" onclick="searchCompanies()">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="alphabet-filter" id="alphabetFilter"></div>
                            </div>
                        </div>
                        
                        <!-- Companies List -->
                        <div id="companiesList">
                            <!-- Companies will be loaded here -->
                        </div>
                        
                        <!-- Load More Button -->
                        <div class="text-center mt-3">
                            <button class="btn admin-btn btn-sm" id="loadMoreCompanies" onclick="loadMoreCompanies()">
                                <i class="fas fa-chevron-down me-1"></i> Load More Companies
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Modal -->
    <div class="modal fade" id="userModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="userModalTitle">Add New User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="userForm">
                        <input type="hidden" id="userId">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="username" class="form-label">Username <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="username" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="email" class="form-label">Email <span class="text-danger">*</span></label>
                                    <input type="email" class="form-control" id="email" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="password" class="form-label">Password <span class="text-danger">*</span></label>
                                    <input type="password" class="form-control" id="password" required>
                                    <small id="passwordHelp" class="form-text text-muted">Leave empty to keep current password when editing</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="role" class="form-label">Role <span class="text-danger">*</span></label>
                                    <select class="form-select" id="role" required onchange="toggleAssignmentSections()">
                                        <option value="">Select Role</option>
                                        <option value="admin">Admin</option>
                                        <option value="user">User</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div id="companyAssignmentSection" class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="form-label mb-0">Assign Companies</label>
                                <div>
                                    <button type="button" class="btn btn-sm btn-outline-secondary me-1" onclick="document.querySelectorAll('.company-checkbox').forEach(cb => cb.checked = true)">
                                        Select All
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="document.querySelectorAll('.company-checkbox').forEach(cb => cb.checked = false)">
                                        Clear All
                                    </button>
                                </div>
                            </div>
                            <div class="mb-2">
                                <input type="text" class="form-control form-control-sm" id="companyAssignmentSearch" placeholder="Search companies">
                            </div>
                            <div id="companyCheckboxList" class="border p-3 rounded" style="max-height: 300px; overflow-y: auto; background-color: #f8f9fa;">
                                <div id="companyLoading" class="text-center py-3">
                                    <div class="spinner-border text-success" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2 mb-0">Loading companies...</p>
                                </div>
                                <!-- Company checkboxes will be inserted here -->
                            </div>
                            <small class="text-muted">Choose the companies this user should have access to. Admins automatically see all companies.</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i> Cancel
                    </button>
                    <button type="button" class="btn admin-btn" id="saveUserBtn" onclick="saveUser()">
                        <i class="fas fa-save me-1"></i> Save User
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Company Modal -->
    <div class="modal fade" id="companyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="companyModalTitle">Add New Company</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="companyForm">
                        <input type="hidden" id="companyId" name="companyId">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="companyName" class="form-label">Company Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="companyName" name="name" required>
                            </div>
                            <div class="col-md-6">
                                <label for="companyEmail" class="form-label">Email <span class="text-danger">*</span></label>
                                <input type="email" class="form-control" id="companyEmail" name="email" required>
                            </div>
                            <div class="col-md-6">
                                <label for="companyPhone" class="form-label">Company Phone <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="companyPhone" name="phone" required>
                            </div>
                            <div class="col-md-6">
                                <label for="companyBillingPhone" class="form-label">Billing Phone <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="companyBillingPhone" name="billing_phone" required>
                            </div>
                            <div class="col-md-6">
                                <label for="companyBillingAttention" class="form-label">Billing Attention <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="companyBillingAttention" name="billing_attention" required>
                            </div>
                            <div class="col-md-6">
                                <label for="companyPostalCode" class="form-label">Postal Code <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="companyPostalCode" name="billing_postal_code" required>
                            </div>
                            <div class="col-12">
                                <label for="companyBillingAddress" class="form-label">Billing Address <span class="text-danger">*</span></label>
                                <textarea class="form-control" id="companyBillingAddress" name="billing_address" rows="2" required></textarea>
                            </div>
                            <div class="col-md-6">
                                <label for="companyBillingStreet" class="form-label">Billing Street <small class="text-muted">(optional)</small></label>
                                <input type="text" class="form-control" id="companyBillingStreet" name="billing_street">
                            </div>
                            <div class="col-md-3">
                                <label for="companyBillingCity" class="form-label">Billing City <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="companyBillingCity" name="billing_city" required>
                            </div>
                            <div class="col-md-3">
                                <label for="companyBillingState" class="form-label">Billing State <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="companyBillingState" name="billing_state" required>
                            </div>
                        </div>
                        <div class="mb-3 mt-3">
                            <label for="companyAssignedTo" class="form-label">Users Assigned To</label>
                            <select class="form-select" id="companyAssignedTo" name="companyAssignedTo" multiple>
                            </select>
                            <div class="assigned-users-preview mt-2" id="assignedUsersPreview" aria-live="polite"></div>
                            <small class="text-muted">Select one or more users to assign this company's customers.</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn admin-btn" onclick="saveCompany()">Save Company</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
    <script>
        let salespersonFilterState = {
            activeUserId: '',
            users: []
        };
        let allUsers = [];
        let currentCompanies = [];
        let currentCompanyPage = 0;
        let currentAlphabetFilter = 'ALL';
        let companyModalInstance = null;
        let lastCompanyModalTrigger = null;
        let totalCompanyCount = 0;
        const companiesPerPage = 1000;

        function buildSalespersonMenu(users) {
            const menu = document.getElementById('salespersonFilterMenu');
            const label = document.getElementById('salespersonFilterLabel');
            if (!menu || !label) return;

            menu.innerHTML = '';

            const filteredUsers = Array.isArray(users)
                ? users.filter(user => (user.role || '').toLowerCase() !== 'admin')
                : [];

            if (salespersonFilterState.activeUserId && !filteredUsers.some(u => String(u.id) === salespersonFilterState.activeUserId)) {
                salespersonFilterState.activeUserId = '';
            }

            const options = [
                {
                    id: '',
                    name: 'All Users',
                    companyCount: getCompanyCountForUser('', users)
                },
                ...filteredUsers.map(user => ({
                    id: user.id,
                    name: user.username || user.email || user.id,
                    companyCount: getCompanyCountForUser(user.id, users)
                }))
            ];

            options.forEach(option => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'filter-option';
                btn.dataset.userId = option.id;
                btn.dataset.userName = option.name;
                btn.innerHTML = `
                    <span>${option.name}</span>
                    <span class="badge bg-light text-dark">${option.companyCount}</span>
                `;

                btn.addEventListener('click', () => {
                    salespersonFilterState.activeUserId = option.id;
                    label.textContent = option.name;
                    applyCompanyFilters();
                });

                menu.appendChild(btn);
            });
        }

        function getCompanyCountForUser(userId, users) {
            if (!userId) {
                return salesCompanyMap.totalCompanies || 0;
            }
            const companies = salesCompanyMap.byUser[userId] || [];
            return companies.length;
        }

        const salesCompanyMap = {
            totalCompanies: 0,
            byUser: {}
        };

        function updateSalesCompanyMap(companies) {
            salesCompanyMap.totalCompanies = Array.isArray(companies) ? companies.length : 0;
            salesCompanyMap.byUser = {};

            if (!Array.isArray(companies)) return;

            companies.forEach(company => {
                const assigned = Array.isArray(company.assigned_to) ? company.assigned_to : [];
                assigned.forEach(userId => {
                    const normalized = String(userId);
                    if (!salesCompanyMap.byUser[normalized]) {
                        salesCompanyMap.byUser[normalized] = [];
                    }
                    salesCompanyMap.byUser[normalized].push(company.id);
                });
            });
        }

        function applyCompanyFilters() {
            const container = document.getElementById('companiesList');
            if (!container) return;
            const filterId = salespersonFilterState.activeUserId;

            const alphabetLetter = currentAlphabetFilter;

            Array.from(container.getElementsByClassName('company-item')).forEach(item => {
                const assigned = item.dataset.assignedUsers ? item.dataset.assignedUsers.split(',') : [];
                const name = (item.dataset.companyName || '').toLowerCase();

                const passesSalesperson = !filterId || assigned.includes(filterId);
                const passesAlphabet = alphabetLetter === 'ALL' || name.startsWith(alphabetLetter.toLowerCase());

                item.style.display = passesSalesperson && passesAlphabet ? '' : 'none';
            });
        }

        function refreshSalespersonFilter(users, companies) {
            salespersonFilterState.users = users || [];
            updateSalesCompanyMap(companies || []);
            buildSalespersonMenu(salespersonFilterState.users);
            applyCompanyFilters();
        }

        const alphabetLetters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');

        function renderAlphabetFilter() {
            const container = document.getElementById('alphabetFilter');
            if (!container) return;
            container.innerHTML = '';

            const letters = ['ALL', ...alphabetLetters];
            letters.forEach(letter => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'alphabet-filter-btn';
                btn.textContent = letter === 'ALL' ? 'All' : letter;
                if (letter === currentAlphabetFilter) {
                    btn.classList.add('active');
                }
                btn.addEventListener('click', () => {
                    currentAlphabetFilter = letter;
                    renderAlphabetFilter();
                    applyCompanyFilters();
                });
                container.appendChild(btn);
            });
        }
        function updateAssignedUsersPreview() {
            const preview = document.getElementById('assignedUsersPreview');
            const select = document.getElementById('companyAssignedTo');

            if (!preview || !select) {
                return;
            }

            const selectedOptions = Array.from(select.selectedOptions || []);

            if (selectedOptions.length === 0) {
                preview.innerHTML = '<span class="text-muted">No users assigned yet.</span>';
                return;
            }

            const badges = selectedOptions.map(option => `
                <span class="badge bg-primary text-wrap assigned-user-badge">${option.textContent.trim()}</span>
            `);

            preview.innerHTML = badges.join('');
        }

// Returns Bootstrap badge color class for a given role
function getRoleBadgeColor(role) {
    switch ((role || '').toLowerCase()) {
        case 'admin':
            return 'success';   // green
        case 'superadmin':
            return 'danger';    // red
        case 'user':
        default:
            return 'secondary'; // gray
    }
}
        
        async function populateCompanyAssignedTo(selectedUserIds = []) {
            const select = document.getElementById('companyAssignedTo');
            if (!select) return;

            const selectedIdsString = Array.isArray(selectedUserIds)
                ? selectedUserIds.map(String)
                : [];

            try {
                if (!Array.isArray(allUsers) || allUsers.length === 0) {
                    const response = await fetch('/api/admin/users');
                    const data = await response.json();
                    if (data.success) {
                        allUsers = Array.isArray(data.users) ? data.users : [];
                    } else {
                        console.error('Failed to load users for company assignment:', data.error);
                        return;
                    }
                }

                select.innerHTML = '';

                const sortedUsers = [...allUsers].sort((a, b) => {
                    const nameA = (a.username || a.email || '').toLowerCase();
                    const nameB = (b.username || b.email || '').toLowerCase();
                    if (nameA < nameB) return -1;
                    if (nameA > nameB) return 1;
                    return 0;
                });

                sortedUsers.forEach(user => {
                    const value = String(user._id || user.id || '');
                    if (!value) return;
                    const label = user.username || user.email || value;
                    const option = document.createElement('option');
                    option.value = value;
                    option.textContent = label;
                    if (selectedIdsString.includes(option.value)) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });

                updateAssignedUsersPreview();
            } catch (error) {
                console.error('Error populating company assignment list:', error);
            }
        }

        $(document).ready(async function() {
            try {
                // Initialize DataTables with error handling
                usersTable = $('#usersTable').DataTable({
                    responsive: true,
                    order: [[4, 'desc']],  // Sort by Created date by default
                    columnDefs: [
                        { orderable: false, targets: [5] },  // Actions column
                        { width: '15%', targets: [0] },      // Username
                        { width: '25%', targets: [1] },      // Email
                        { width: '10%', targets: [2] },      // Role
                        { width: '15%', targets: [3] },      // Assigned Companies
                        { width: '15%', targets: [4] },      // Created
                        { width: '20%', targets: [5] }       // Actions
                    ],
                    // Add error handling
                    error: function(settings, techNote, message) {
                        console.error('DataTables error:', message);
                    },
                    // Disable automatic width calculation
                    autoWidth: false,
                    // Enable horizontal scrolling if needed
                    scrollX: true
                });

                // Initialize other tables if they exist
                renderAlphabetFilter();

                await Promise.all([
                    loadUsers(),
                    loadCompanies()
                ]);
            } catch (error) {
                console.error('Error initializing page:', error);
            }
        });
        
        // Load users data
        function loadUsers() {
            fetch('/api/admin/users')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        allUsers = Array.isArray(data.users) ? data.users : [];
                        populateUsersTable(data.users);
                        // Refresh company assignment select if modal is open
                        populateCompanyAssignedTo();
                        refreshSalespersonFilter(allUsers, currentCompanies);
                    } else {
                        console.error('Failed to load users:', data.error);
                        alert('Failed to load users. Please try again.');
                    }
                })
                .catch(error => {
                    console.error('Error loading users:', error);
                    alert('Error loading users. Please check console for details.');
                });
        }
        
        // Populate users table
        function populateUsersTable(users) {
            const tbody = document.getElementById('usersTableBody');
            if (!tbody) return;
            
            // Clear existing rows using DataTables API if available
            if ($.fn.DataTable.isDataTable('#usersTable') && usersTable) {
                usersTable.clear().draw();
            } else {
                tbody.innerHTML = '';
            }
            
            // If no users, show message
            if (!users || users.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = '<td colspan="6" class="text-center">No users found</td>';
                tbody.appendChild(tr);
                return;
            }
            
            // Prepare data for DataTables
            const rows = users.map(user => {
                // Format created date
                const createdDate = new Date(user.created_at);
                const formattedDate = createdDate.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                
                // Create action buttons
                const actions = `
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-sm admin-btn" onclick="editUser('${user._id || user.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-danger" onclick="deleteUser('${user._id || user.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                const assignedCompanyCount = Array.isArray(user.assigned_companies) ? user.assigned_companies.length : 0;

                return [
                    user.username || '-',
                    user.email || '-',
                    `<span class="badge bg-${getRoleBadgeColor(user.role)}">${user.role || 'user'}</span>`,
                    assignedCompanyCount,
                    formattedDate,
                    actions
                ];
            });
            
            // Add rows to DataTable or directly to tbody
            if ($.fn.DataTable.isDataTable('#usersTable') && usersTable) {
                usersTable.rows.add(rows).draw();
            } else {
                // Fallback if DataTables is not initialized
                rows.forEach(rowData => {
                    const tr = document.createElement('tr');
                    rowData.forEach((cellData, index) => {
                        const td = document.createElement('td');
                        if (index === 5) { // Actions column
                            td.className = 'text-nowrap';
                        }
                        td.innerHTML = cellData;
                        tr.appendChild(td);
                    });
                    tbody.appendChild(tr);
                });
            }
        }
        
        // Load companies data
        async function loadCompanies(page = 0) {
            try {
                const response = await fetch(`/api/admin/companies?page=${page}&limit=${companiesPerPage}`);
                const data = await response.json();
                
                if (data.error || data.success === false) {
                    console.error('Error loading companies:', data.error || 'Unknown error');
                    return;
                }
                const companies = Array.isArray(data.companies) ? data.companies : [];
                if (typeof data.total === 'number') {
                    totalCompanyCount = data.total;
                }
                
                if (page === 0) {
                    currentCompanies = companies;
                    populateCompaniesList(companies);
                } else {
                    currentCompanies = currentCompanies.concat(companies);
                    appendCompaniesList(companies);
                }
                refreshSalespersonFilter(allUsers, currentCompanies);
                
                // Show/hide load more button
                const loadMoreBtn = document.getElementById('loadMoreCompanies');
                if (loadMoreBtn) {
                    if (totalCompanyCount && currentCompanies.length >= totalCompanyCount) {
                        loadMoreBtn.style.display = 'none';
                    } else if (companies.length < companiesPerPage) {
                        loadMoreBtn.style.display = 'none';
                    } else {
                        loadMoreBtn.style.display = 'block';
                    }
                }
                
            } catch (error) {
                console.error('Error loading companies:', error);
            }
        }
        
        // Populate companies list
        function populateCompaniesList(companies) {
            const container = document.getElementById('companiesList');
            container.innerHTML = '';
            
            companies.forEach(company => {
                const item = createCompanyItem(company);
                container.appendChild(item);
            });
            applyCompanyFilters();
        }
        
        // Append companies to list
        function appendCompaniesList(companies) {
            const container = document.getElementById('companiesList');
            
            companies.forEach(company => {
                const item = createCompanyItem(company);
                container.appendChild(item);
            });
            applyCompanyFilters();
        }
        
        function getCompanyAssignedCount(company) {
            if (typeof company.assigned_to_count === 'number') {
                return company.assigned_to_count;
            }
            if (Array.isArray(company.assigned_to)) {
                return company.assigned_to.length;
            }
            return 0;
        }

        function extractAssignedUsers(company) {
            if (!company) return [];
            const assigned = Array.isArray(company.assigned_to) ? company.assigned_to : [];
            return assigned.map(id => String(id)).filter(Boolean);
        }

        function buildCompanyItemContent(company) {
            const assignedCount = getCompanyAssignedCount(company);
            return `
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="mb-1">${company.name} <span class="badge bg-info">${assignedCount}</span></h6>
                        <p class="mb-1 text-muted">${company.email}</p>
                        <small class="text-muted">${company.billing_address || company.address || '-'}</small>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-primary btn-action" onclick="editCompany('${company.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger btn-action" onclick="deleteCompany('${company.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        }

        function setCompanyItemData(item, company) {
            if (!item || !company) return;
            const assignedUsers = extractAssignedUsers(company);
            item.dataset.companyId = company.id || '';
            item.dataset.assignedUsers = assignedUsers.join(',');
            item.dataset.companyName = (company.name || '').toLowerCase();
        }

        // Create company item element
        function createCompanyItem(company) {
            const item = document.createElement('div');
            item.className = 'company-item';
            item.innerHTML = buildCompanyItemContent(company);
            setCompanyItemData(item, company);
            return item;
        }

        function updateCompanyItem(company) {
            const container = document.getElementById('companiesList');
            if (!container || !company || !company.id) {
                return;
            }
            const existing = container.querySelector(`.company-item[data-company-id="${company.id}"]`);
            if (existing) {
                existing.innerHTML = buildCompanyItemContent(company);
                setCompanyItemData(existing, company);
            } else {
                const item = createCompanyItem(company);
                container.prepend(item);
            }
            applyCompanyFilters();
        }

        function removeCompanyItem(companyId) {
            const container = document.getElementById('companiesList');
            if (!container) {
                return;
            }
            const target = container.querySelector(`.company-item[data-company-id="${companyId}"]`);
            if (target) {
                target.remove();
            }
        }
        
        async function loadAllCompaniesForAssignment(selectedCompanyIds = []) {
            const loadingIndicator = document.getElementById('companyLoading');
            const companyList = document.getElementById('companyCheckboxList');
            const searchInput = document.getElementById('companyAssignmentSearch');

            if (!companyList) return;

            if (loadingIndicator) {
                loadingIndicator.style.display = 'block';
            }

            try {
                if (!Array.isArray(allCompaniesForAssignment) || allCompaniesForAssignment.length === 0) {
                    const companiesToUse = currentCompanies.length ? currentCompanies : await preloadCompaniesForAssignment();
                    allCompaniesForAssignment = Array.isArray(companiesToUse) ? companiesToUse : [];
                }

                allCompaniesForAssignment = Array.isArray(allCompaniesForAssignment) ? allCompaniesForAssignment : [];
                allCompaniesForAssignment.sort((a, b) => {
                    const nameA = (a.name || '').toLowerCase();
                    const nameB = (b.name || '').toLowerCase();
                    if (nameA < nameB) return -1;
                    if (nameA > nameB) return 1;
                    return 0;
                });

                companyList.innerHTML = '';

                if (!Array.isArray(allCompaniesForAssignment) || allCompaniesForAssignment.length === 0) {
                    companyList.innerHTML = '<div class="alert alert-info mb-0">No companies available. Please add companies first.</div>';
                    return;
                }

                if (searchInput) {
                    searchInput.value = '';
                }

                const selectedSet = new Set((selectedCompanyIds || []).map(String));

                allCompaniesForAssignment.forEach(company => {
                    const companyId = String(company.id || company._id || '');
                    if (!companyId) return;

                    const searchValue = `${(company.name || '').toLowerCase()} ${(company.email || '').toLowerCase()}`.trim();
                    const wrapper = document.createElement('div');
                    wrapper.className = 'form-check mb-2 company-checkbox-wrapper';
                    wrapper.dataset.search = searchValue;
                    wrapper.innerHTML = `
                        <input class="form-check-input company-checkbox" type="checkbox" value="${companyId}" id="assign-company-${companyId}" ${selectedSet.has(companyId) ? 'checked' : ''}>
                        <label class="form-check-label" for="assign-company-${companyId}">
                            ${company.name || 'Unnamed Company'}
                            ${company.email ? `<small class="text-muted d-block">${company.email}</small>` : ''}
                        </label>
                    `;
                    companyList.appendChild(wrapper);
                });

                document.querySelectorAll('.company-checkbox-wrapper').forEach(item => {
                    item.style.display = '';
                });
            } catch (error) {
                console.error('Error loading companies for assignment:', error);
                companyList.innerHTML = `<div class="alert alert-danger">${error.message || 'Failed to load companies.'}</div>`;
            } finally {
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'none';
                }
            }
        }

        async function preloadCompaniesForAssignment() {
            try {
                const response = await fetch('/api/admin/companies?page=0&limit=1000');
                const data = await response.json();
                if (data.success) {
                    return Array.isArray(data.companies) ? data.companies : [];
                }
            } catch (error) {
                console.error('Error preloading companies for assignment:', error);
            }
            return [];
        }

        document.addEventListener('DOMContentLoaded', () => {
            const assignedSelect = document.getElementById('companyAssignedTo');
            if (assignedSelect) {
                assignedSelect.addEventListener('change', updateAssignedUsersPreview);
            }

            const modalEl = document.getElementById('companyModal');
            if (modalEl && !companyModalInstance) {
                companyModalInstance = new bootstrap.Modal(modalEl);
                modalEl.addEventListener('hide.bs.modal', () => {
                    const active = document.activeElement;
                    if (modalEl.contains(active)) {
                        active.blur();
                        if (lastCompanyModalTrigger && typeof lastCompanyModalTrigger.focus === 'function') {
                            lastCompanyModalTrigger.focus();
                        }
                    }
                });
                modalEl.addEventListener('hidden.bs.modal', () => {
                    updateAssignedUsersPreview();
                    if (lastCompanyModalTrigger && typeof lastCompanyModalTrigger.focus === 'function') {
                        lastCompanyModalTrigger.focus();
                    }
                    lastCompanyModalTrigger = null;
                });
            }

            updateAssignedUsersPreview();
        });

        const companyAssignmentSearch = document.getElementById('companyAssignmentSearch');
        if (companyAssignmentSearch) {
            companyAssignmentSearch.addEventListener('input', () => {
                const term = companyAssignmentSearch.value.trim().toLowerCase();
                document.querySelectorAll('.company-checkbox-wrapper').forEach(item => {
                    const text = item.dataset.search || '';
                    item.style.display = term ? (text.includes(term) ? '' : 'none') : '';
                });
            });
        }

        // Toggle assignment sections based on role
        function toggleAssignmentSections() {
            const roleSelect = document.getElementById('role');
            const companySection = document.getElementById('companyAssignmentSection');
            
            if (roleSelect && companySection) {
                const isAdmin = roleSelect.value === 'admin';
                companySection.style.display = isAdmin ? 'none' : 'block';

                if (!isAdmin && allCompaniesForAssignment.length === 0) {
                    loadAllCompaniesForAssignment();
                }
            }
        }

        function getSelectedCompanyIds() {
            const checkboxes = document.querySelectorAll('.company-checkbox:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        // Show add user modal
        function showAddUserModal() {
            const modal = new bootstrap.Modal(document.getElementById('userModal'));
            document.getElementById('userModalTitle').textContent = 'Add New User';
            document.getElementById('userForm').reset();
            document.getElementById('userId').value = '';
            document.getElementById('password').required = true;
            document.getElementById('role').value = 'user';
            
            // Load companies for assignment
            loadAllCompaniesForAssignment();
            
            // Show company assignment section
            document.getElementById('companyAssignmentSection').classList.remove('d-none');
            toggleAssignmentSections();
            
            modal.show();
        }
        
        async function showAddCompanyModal() {
            lastCompanyModalTrigger = document.activeElement;
            document.getElementById('companyModalTitle').textContent = 'Add New Company';
            document.getElementById('companyForm').reset();
            document.getElementById('companyId').value = '';
            await populateCompanyAssignedTo();
            const select = document.getElementById('companyAssignedTo');
            if (select) Array.from(select.options).forEach(opt => opt.selected = false);
            if (!companyModalInstance) {
                const modalEl = document.getElementById('companyModal');
                companyModalInstance = modalEl ? new bootstrap.Modal(modalEl) : null;
            }
            if (companyModalInstance) {
                companyModalInstance.show();
            }
        }
        
        // CRUD operations
        function saveUser() {
            const userId = document.getElementById('userId').value;
            const username = document.getElementById('username').value.trim();
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const role = document.getElementById('role').value;
            
            if (!username || !email || !role) {
                alert('Please fill in all required fields');
                return;
            }
            
            const userData = {
                username,
                email,
                role,
                assigned_companies: getSelectedCompanyIds()
            };
            
            // Only include password if it's not empty (for updates)
            if (password) {
                userData.password = password;
            }
            
            const method = userId ? 'PUT' : 'POST';
            const url = userId ? `/api/admin/users/${userId}` : '/api/admin/users';
            
            // Show loading state
            const saveBtn = document.getElementById('saveUserBtn');
            const originalBtnText = saveBtn.innerHTML;
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span> Saving...';
            
            fetch(url, {
                method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(userData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast(userId ? 'User updated successfully' : 'User created successfully', 'success');
                    const modalInstance = bootstrap.Modal.getInstance(document.getElementById('userModal'));
                    if (modalInstance) {
                        modalInstance.hide();
                    }
                    loadUsers();
                    loadCompanies();
                } else {
                    throw new Error(data.error || 'Failed to save user');
                }
            })
            .catch(error => {
                console.error('Error saving user:', error);
                showToast(`Error: ${error.message}`, 'danger');
            })
            .finally(() => {
                saveBtn.disabled = false;
                saveBtn.innerHTML = originalBtnText;
            });
        }

        // Show toast notification
        function showToast(message, type = 'info') {
            let toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toastContainer';
                toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
                toastContainer.setAttribute('aria-live', 'polite');
                toastContainer.setAttribute('aria-atomic', 'true');
                document.body.appendChild(toastContainer);
            }
            const toastId = 'toast-' + Date.now();
            const toastHtml = `
                <div id="${toastId}" class="toast align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;
            
            try {
                toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            } catch (err) {
                console.error('Failed to render toast', err, message);
                return;
            }
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement, { autohide: true, delay: 5000 });
            toast.show();
            
            // Remove toast after it's hidden
            toastElement.addEventListener('hidden.bs.toast', function () {
                toastElement.remove();
            });
        }

        function editUser(userId) {
            fetch(`/api/admin/users/${userId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const user = data.user;
                        document.getElementById('userModalTitle').textContent = 'Edit User';
                        document.getElementById('userId').value = user.id;
                        document.getElementById('username').value = user.username;
                        document.getElementById('email').value = user.email;
                        document.getElementById('role').value = user.role;
                        document.getElementById('password').required = false;
                        
                        // Toggle assignment sections based on role
                        toggleAssignmentSections();
                        
                        // Load companies and select the assigned ones
                        loadAllCompaniesForAssignment(user.assigned_companies || []);

                        const modal = new bootstrap.Modal(document.getElementById('userModal'));
                        modal.show();
                    } else {
                        throw new Error(data.error || 'Failed to load user data');
                    }
                })
                .catch(error => {
                    console.error('Error loading user data:', error);
                    showToast(`Error: ${error.message}`, 'danger');
                });
        }
        
        async function deleteUser(userId) {
            if (confirm('Are you sure you want to delete this user?')) {
                try {
                    const response = await fetch(`/api/admin/users/${userId}`, {
                        method: 'DELETE'
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        loadUsers();
                        alert('User deleted successfully!');
                    } else {
                        alert('Error deleting user: ' + result.error);
                    }
                    
                } catch (error) {
                    console.error('Error deleting user:', error);
                    alert('Error deleting user');
                }
            }
        }
        
        // Company functions
        async function saveCompany() {
            const form = document.getElementById('companyForm');
            const formData = new FormData(form);
            const companyData = Object.fromEntries(formData);
            const requiredFields = ['name', 'email', 'phone', 'billing_phone', 'billing_attention', 'billing_address', 'billing_city', 'billing_state', 'billing_postal_code'];
            for (const field of requiredFields) {
                if (!companyData[field] || !companyData[field].trim()) {
                    alert('Please fill out all required company fields.');
                    return;
                }
            }
            // Collect assigned users from multi-select
            const assignedSelect = document.getElementById('companyAssignedTo');
            if (assignedSelect) {
                companyData.assigned_to = Array.from(assignedSelect.selectedOptions).map(o => o.value);
            }
            
            try {
                const url = companyData.companyId ? `/api/admin/companies/${companyData.companyId}` : '/api/admin/companies';
                const method = companyData.companyId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(companyData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    if (companyModalInstance) {
                        companyModalInstance.hide();
                    } else {
                        bootstrap.Modal.getInstance(document.getElementById('companyModal'))?.hide();
                    }

                    if (result.company) {
                        updateCompanyItem(result.company);
                    } else {
                        loadCompanies();
                    }

                    if (Array.isArray(result.users)) {
                        result.users.forEach(user => updateUserRow(user));
                    } else {
                        loadUsers();
                    }

                    updateAssignedUsersPreview();
                    alert('Company saved successfully!');
                } else {
                    alert('Error saving company: ' + result.error);
                }
                
            } catch (error) {
                console.error('Error saving company:', error);
                alert('Error saving company');
            }
        }
        
        async function editCompany(companyId) {
            try {
                const response = await fetch(`/api/admin/companies/${companyId}`);
                const data = await response.json();
                
                if (data.success) {
                    const company = data.company;
                    lastCompanyModalTrigger = document.activeElement;
                    document.getElementById('companyModalTitle').textContent = 'Edit Company';
                    document.getElementById('companyId').value = company.id;
                    document.getElementById('companyName').value = company.name || '';
                    document.getElementById('companyEmail').value = company.email || '';
                    document.getElementById('companyPhone').value = company.phone || '';
                    document.getElementById('companyBillingAttention').value = company.billing_attention || '';
                    document.getElementById('companyBillingAddress').value = company.billing_address || '';
                    document.getElementById('companyBillingStreet').value = company.billing_street || '';
                    document.getElementById('companyBillingCity').value = company.billing_city || '';
                    document.getElementById('companyBillingState').value = company.billing_state || '';
                    document.getElementById('companyPostalCode').value = company.billing_postal_code || '';
                    document.getElementById('companyBillingPhone').value = company.billing_phone || '';

                    // Populate and preselect assigned users if provided
                    await populateCompanyAssignedTo(company.assigned_to || []);
                    const select = document.getElementById('companyAssignedTo');
                    const assigned = (company.assigned_to || []).map(String);
                    if (select) {
                        Array.from(select.options).forEach(opt => {
                            opt.selected = assigned.includes(opt.value);
                        });
                    }

                    updateAssignedUsersPreview();

                    if (!companyModalInstance) {
                        const modalEl = document.getElementById('companyModal');
                        companyModalInstance = modalEl ? new bootstrap.Modal(modalEl) : null;
                    }
                    if (companyModalInstance) {
                        companyModalInstance.show();
                    }
                }
                
            } catch (error) {
                console.error('Error loading company:', error);
            }
        }
        
        async function deleteCompany(companyId) {
            if (confirm('Are you sure you want to delete this company?')) {
                try {
                    const response = await fetch(`/api/admin/companies/${companyId}`, {
                        method: 'DELETE'
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        removeCompanyItem(companyId);
                        if (Array.isArray(result.users)) {
                            result.users.forEach(user => updateUserRow(user));
                        } else {
                            loadUsers();
                        }
                        alert('Company deleted successfully!');
                    } else {
                        alert('Error deleting company: ' + result.error);
                    }
                    
                } catch (error) {
                    console.error('Error deleting company:', error);
                    alert('Error deleting company');
                }
            }
        }
        
        // Load all customers for assignment
        async function loadAllCustomers(selectedCustomerIds = []) {
            const loadingIndicator = document.getElementById('customerLoading');
            const customerList = document.getElementById('customerCheckboxList');

            if (!customerList) return;

            try {
                // Show loading state
                if (loadingIndicator) loadingIndicator.style.display = 'block';
                if (customerList) customerList.style.display = 'none';
                
                // Make sure we're using the correct API endpoint
                const response = await fetch('/api/customers', {
                    headers: {
                        'Accept': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                // Hide loading indicator
                if (loadingIndicator) loadingIndicator.style.display = 'none';
                if (customerList) customerList.style.display = 'block';
                
                // Handle different response formats
                let customers = [];
                if (Array.isArray(data)) {
                    customers = data;
                } else if (data && (data.data || data.customers)) {
                    customers = data.data || data.customers || [];
                }
                
                // Store customers globally for filtering
                window.allCustomers = customers;
                
                // Render the checkboxes
                renderCustomerCheckboxes(customers, selectedCustomerIds);
                
                return customers;
                
            } catch (error) {
                console.error('Failed to load customers:', error);
                
                // Update UI to show error state
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'none';
                }
                
                if (customerList) {
                    customerList.innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Failed to load customers. ${error.message || 'Please try again later.'}
                        </div>`;
                    customerList.style.display = 'block';
                }
                
                // Fallback to empty array
                window.allCustomers = [];
                showToast('Error loading customers. Please check console for details.', 'danger');
                return [];
            }
        }

        // Search and pagination
        async function searchCompanies() {
            const query = document.getElementById('companySearch').value;
            try {
                const response = await fetch(`/api/admin/companies/search?q=${encodeURIComponent(query)}`);
                const data = await response.json();
                
                if (data.success) {
                    const companies = Array.isArray(data.companies) ? data.companies : [];
                    currentCompanies = companies;
                    populateCompaniesList(companies);
                    refreshSalespersonFilter(allUsers, currentCompanies);
                    document.getElementById('loadMoreCompanies').style.display = 'none';
                }
                
            } catch (error) {
                console.error('Error searching companies:', error);
            }
        }
        
        function loadMoreCompanies() {
            currentCompanyPage++;
            loadCompanies(currentCompanyPage);
        }
        
        function exportCompanies() {
            fetch('/api/admin/companies/export')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Export failed');
                    }
                    return response.blob();
                })
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = 'companies_export.csv';
                    document.body.appendChild(link);
                    link.click();
                    link.remove();
                    window.URL.revokeObjectURL(url);
                })
                .catch(error => {
                    console.error('Error exporting companies:', error);
                    alert('Failed to export companies. Please try again later.');
                });
        }

        function triggerCompanyImport() {
            const input = document.getElementById('companyImportInput');
            if (input) {
                input.value = '';
                input.click();
            }
        }

        async function handleCompanyImport(event) {
            const file = event.target.files && event.target.files[0];
            if (!file) {
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/api/admin/companies/import', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    let message = `Inserted: ${result.inserted}\nUpdated: ${result.updated}`;
                    if (Array.isArray(result.errors) && result.errors.length) {
                        message += `\nErrors:\n${result.errors.join('\n')}`;
                    }
                    alert(message);
                    currentCompanyPage = 0;
                    await loadCompanies(0);
                } else {
                    alert(`Import failed: ${result.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Import failed:', error);
                alert('Failed to import companies. Please try again later.');
            } finally {
                event.target.value = '';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const importInput = document.getElementById('companyImportInput');
            if (importInput) {
                importInput.addEventListener('change', handleCompanyImport);
            }
        });
    </script>
{% endblock %}
