{% extends "base.html" %}

{% block title %}MPACK Selection - Product Calculator{% endblock %}

{% block content %}
  <div class="container my-5">
  <h2>MPACK Selection</h2>

  <style>
    .mpack-diagram-column {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      align-items: center;
    }

    @media (min-width: 768px) {
      .mpack-diagram-column {
        align-items: flex-start;
      }
    }

    .mpack-diagram-figure {
      width: 100%;
      max-width: 260px;
    }

    .mpack-diagram-figure svg {
      width: 100%;
      height: auto;
      display: block;
    }

    .mpack-select-wrapper {
      width: 100%;
    }
  </style>

  <div class="mb-3">
    <div class="d-flex align-items-end gap-2">
      <div class="flex-grow-1">
        <label for="machineSelect" class="form-label">Select Machine/Model <span class="text-muted small">(optional)</span>:</label>
        <select id="machineSelect" class="form-select">
          <option value="">-- Select Machine --</option>
        </select>
        <div class="form-text text-muted">Leave blank if the machine is unknown. The quotation will display `--`.</div>
      </div>
      <div>
        <a href="{{ url_for('add_machine', next=url_for('mpacks')) }}" class="btn btn-outline-gold">
          <i class="fas fa-plus"></i> New Machine
        </a>
      </div>
    </div>
  </div>

  <!-- Underpacking Type Selection -->
  <div class="mb-3">
    <label for="underpackingType" class="form-label">Select Underpacking Type:</label>
    <select id="underpackingType" class="form-select">
      <option value="">-- Select Underpacking Type --</option>
      <option value="mtech_mpack">Mtech Mpack</option>
      <option value="mark3zet">Mark3zet</option>
    </select>
  </div>

  <div id="mpackSection" style="display:none;">
    <!-- Size selection first -->
    <div class="row mb-3 align-items-start">
      <div class="col-md-6">
        <div class="row g-4 align-items-start mb-3">
          <div class="col-md-6 mpack-diagram-column">
            <figure class="mpack-diagram-figure d-flex flex-column align-items-center align-items-md-start text-center text-md-start gap-1 mb-0">
              <svg viewBox="0 0 300 200" width="300" height="190" role="img" aria-labelledby="acrossDiagramTitle acrossDiagramDesc">
                <title id="acrossDiagramTitle">Across direction illustration</title>
                <desc id="acrossDiagramDesc">Cylinder with straight arrow indicating the across measurement.</desc>
                <defs>
                  <marker id="acrossArrowHead" markerWidth="8" markerHeight="8" refX="4" refY="4" orient="auto">
                    <path d="M0,0 L8,4 L0,8 z" fill="#000000" />
                  </marker>
                </defs>
                <g fill="none" stroke="#111827" stroke-width="4" stroke-linecap="round" stroke-linejoin="round">
                  <line x1="35" y1="35" x2="265" y2="35" stroke="#000000" stroke-width="3" marker-start="url(#acrossArrowHead)" marker-end="url(#acrossArrowHead)" />
                  <rect x="40" y="60" width="220" height="50" rx="25" ry="25" />
                  <rect x="40" y="110" width="220" height="50" rx="25" ry="25" />
                  <circle cx="235" cy="85" r="25" />
                  <circle cx="235" cy="135" r="25" />
                </g>
                <text x="150" y="25" text-anchor="middle" font-size="18" font-weight="bold" fill="#000000" style="font-family: Arial, sans-serif;">Across</text>
              </svg>
              <figcaption class="fw-semibold">Across (Cylinder width)</figcaption>
              <span class="text-muted small">Measure straight across the cylinder.</span>
            </figure>
            <div class="mpack-select-wrapper">
              <label class="form-label" for="customWidthInput">Across (mm)</label>
              <select class="form-select" id="customWidthInput">
                <option value="">-- Select Across --</option>
              </select>
            </div>
          </div>
          <div class="col-md-6 mpack-diagram-column">
            <figure class="mpack-diagram-figure d-flex flex-column align-items-center align-items-md-start text-center text-md-start gap-1 mb-0">
              <svg viewBox="0 0 320 180" width="300" height="170" role="img" aria-labelledby="aroundDiagramTitle aroundDiagramDesc">
                <title id="aroundDiagramTitle">Around direction illustration</title>
                <desc id="aroundDiagramDesc">Single cylinder with an exterior wrap arrow indicating the around measurement.</desc>
                <defs>
                  <marker id="aroundArrowHead" markerWidth="12" markerHeight="12" refX="15" refY="6" orient="auto" markerUnits="strokeWidth">
                    <!-- Mirrored arrowhead, same reference point -->
                    <path d="M12,0 L0,6 L12,12 L8.5,6 Z" fill="#ffffff" stroke="#111827" stroke-width="1.2" />
                  </marker>
                </defs>
                <g fill="none" stroke="#111827" stroke-width="4" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="86" cy="90" r="30" />
                  <circle cx="234" cy="90" r="30" />
                  <path d="M86 60 H234" />
                  <path d="M86 120 H234" />
                </g>
                <g stroke-linecap="round" stroke-linejoin="round">
                  <path d="M160 128 A34 34 0 0 0 160 52 L190 52" fill="none" stroke="#111827" stroke-width="4" stroke-linecap="butt" marker-end="url(#aroundArrowHead)" />
                </g>
                <text x="160" y="25" text-anchor="middle" font-size="18" font-weight="bold" fill="#111827" style="font-family: Arial, sans-serif;">Around</text>
              </svg>
              <figcaption class="fw-semibold">Around (Cylinder circumference)</figcaption>
              <span class="text-muted small">Measure around the cylinder.</span>
            </figure>
            <div class="mpack-select-wrapper">
              <label class="form-label" for="customLengthInput">Around (mm)</label>
              <select class="form-select" id="customLengthInput">
                <option value="">-- Select Around --</option>
              </select>
            </div>
          </div>
        </div>
        <div class="form-text">Select preset sizes to populate measurements automatically.</div>
        <div class="form-text text-muted" id="customSizeSummary">Select sizes to see sq.m., then choose a thickness.</div>
        <div class="text-danger small mt-1 d-none" id="customSizeFeedback">Please enter both across and around measurements to continue.</div>
      </div>
      <div class="col-md-6">
        <label for="thicknessSelect" class="form-label">Select Thickness (micron)</label>
        <select id="thicknessSelect" class="form-select" disabled>
          <option value="">-- Select Thickness --</option>
        </select>
        <div class="form-text text-muted mt-2">Thickness options become available once a size is selected.</div>
      </div>
    </div>

    <div id="cutQuestionSection" class="card mb-3" style="display:none;">
      <div class="card-body">
        <label class="form-label d-block">Should we cut the underpacking to your entered size?</label>
        <div class="d-flex flex-wrap align-items-start gap-4">
          <div class="form-check">
            <input class="form-check-input" type="radio" name="cutFromInput" id="cutYes" value="yes">
            <label class="form-check-label" for="cutYes">
              Yes
              <span class="text-muted small d-block">(Price will still be taken as per standard sizes considering wastage.)</span>
            </label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="cutFromInput" id="cutNo" value="no">
            <label class="form-check-label" for="cutNo">No</label>
          </div>
        </div>
      </div>
    </div>

    <div id="cutDetailsSection" class="alert alert-info" style="display:none;">
      <h6 class="mb-2">Cutting summary</h6>
      <div class="d-flex justify-content-between" id="cutStandardRow" style="display:none;">
        <span>Standard sheet area:</span>
        <span><strong><span id="standardAreaDisplay">0.000</span> sq.m</strong></span>
      </div>
      <div class="d-flex justify-content-between" id="cutCustomRow" style="display:none;">
        <span>Your required size area:</span>
        <span><strong><span id="customAreaDisplay">0.000</span> sq.m</strong></span>
      </div>
      <p class="mb-0 text-muted small" id="cutDetailsNote">Select whether we should cut to your entered size. Pricing remains based on the selected standard size.</p>
    </div>

    <!-- Price Calculation Section -->
    <section class="pricing-section" id="priceSection" style="display:none;">
      <div class="pricing-container">
        <div class="pricing-preview mb-3">
          <div class="pricing-breakdown" id="pricingBreakdown">
            <p class="text-muted mb-0">Select thickness and sizes to see pricing.</p>
          </div>
        </div>
        <div class="pricing-options mb-4">
          <div class="row g-3 align-items-end">
            <div class="col-md-4">
              <label for="sheetInput" class="form-label">Quantity (Sheets)</label>
              <input type="number" id="sheetInput" class="form-control" min="1" value="1" />
            </div>
            <div class="col-md-4">
              <label for="discountSelect" class="form-label">Discount (%) <span class="text-muted">(optional)</span></label>
              <select id="discountSelect" class="form-select">
                <option value="">-- Select Discount --</option>
              </select>
            </div>
            <div class="col-md-4">
              <label for="gstSelect" class="form-label">GST Rate</label>
              <input type="text" id="gstDisplay" class="form-control" value="18%" disabled>
              <input type="hidden" id="gstSelect" value="18">
            </div>
          </div>
        </div>
        <div class="pricing-actions">
          <button class="btn btn-primary" id="addToCartBtn" disabled>Add to Cart</button>
        </div>
        <div id="cart-message" class="mt-2"></div>
      </div>
    </section>
  </div>

  <!-- Scripts -->
  <script src="{{ url_for('static', filename='user/js/mpack.js') }}"></script>
  <script src="{{ url_for('static', filename='user/js/cart.js') }}"></script>
  <script>
    // Initialize cart count when page loads
    document.addEventListener('DOMContentLoaded', function() {
      updateCartCount();
      
      // Initialize size search functionality
      function initSizeSearch() {
        const sizeInput = document.getElementById('sizeInput');
        const sizeSelect = document.getElementById('sizeSelect');
        const sizeSuggestions = document.getElementById('sizeSuggestions');
        if (!sizeInput || !sizeSelect) return;

        // Update hidden select and trigger change
        function selectSize(value, text) {
          sizeSelect.value = value;
          sizeInput.value = text;
          sizeSuggestions.style.display = 'none';
          setTimeout(() => {
            sizeSelect.dispatchEvent(new Event('change'));
          }, 10);
        }

        // Update suggestion list
        function updateSuggestions() {
          const searchTerm = sizeInput.value.toLowerCase();
          const options = Array.from(sizeSelect.options);
          sizeSuggestions.innerHTML = '';
          if (!searchTerm) { sizeSuggestions.style.display = 'none'; return; }
          const matches = options.filter(opt => opt.value && (opt.text.toLowerCase().includes(searchTerm) || opt.text.replace(/[^0-9x]/g,'').includes(searchTerm)));
          const list = matches.length ? matches : [{text:'No matching sizes found', value:''}];
          list.forEach(opt => {
            const el = document.createElement(matches.length ? 'button' : 'div');
            if (matches.length) {
              el.type='button'; el.className='list-group-item list-group-item-action'; el.textContent=opt.text;
              el.onclick=()=>selectSize(opt.value, opt.text);
            } else { el.className='list-group-item'; el.textContent=opt.text; }
            sizeSuggestions.appendChild(el);
          });
          sizeSuggestions.style.display='block';
        }

        sizeInput.addEventListener('input', updateSuggestions);
        document.addEventListener('click', e => { if (e.target!==sizeInput && e.target!==sizeSuggestions) sizeSuggestions.style.display='none'; });
        sizeInput.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); const first=sizeSuggestions.querySelector('button'); first && first.click(); }});
        new MutationObserver(updateSuggestions).observe(sizeSelect,{childList:true});
        updateSuggestions();
      }

      // Initialize size search functionality
      initSizeSearch();
      
      // Show/hide discount section
      window.showDiscountSection = function() {
        const discountSection = document.getElementById('discountSection');
        if (discountSection) {
          discountSection.style.display = discountSection.style.display === 'none' ? 'block' : 'none';
        }
      };
    });
  </script>
{% endblock %}