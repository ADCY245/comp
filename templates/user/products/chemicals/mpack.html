{% extends "base.html" %}

{% block title %}MPACK Selection - Product Calculator{% endblock %}

{% block content %}
  <div class="container my-5">
  <h2>MPACK Selection</h2>

  <style>
    .mpack-diagram-column {
      display: grid;
      grid-template-rows: 1fr auto;
      row-gap: 1.5rem;
      align-items: stretch;
      height: 100%;
    }

    .mpack-diagram-column > * {
      width: 100%;
    }

    .mpack-diagram-figure {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-between;
      text-align: center;
      gap: 0.75rem;
      width: 100%;
      flex: 1;
      min-height: 240px;
      padding: 1rem 1.5rem;
    }

    .mpack-diagram-figure svg {
      width: 100%;
      height: auto;
      max-width: 260px;
      margin: 0 auto;
      display: block;
    }

    .mpack-select-wrapper {
      width: 100%;
      max-width: 320px;
    }

    @media (min-width: 768px) {
      .mpack-diagram-figure {
        align-items: flex-start;
        text-align: left;
      }

      .mpack-diagram-figure svg {
        margin: 0;
      }

      .mpack-select-wrapper {
        margin-top: auto;
      }
    }

    .mpack-pricing-controls {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .mpack-thickness-row {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 1rem;
      align-items: start;
    }

    .mpack-pricing-controls .form-select,
    .mpack-pricing-controls .form-control {
      width: 100%;
      max-width: 220px;
    }

    .mpack-thickness-primary {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      max-width: 220px;
    }

    .mpack-thickness-primary .form-text {
      margin-bottom: 0.25rem;
    }

    .mpack-standard-column {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      max-width: 220px;
    }

    .mpack-standard-column .form-label,
    .mpack-standard-column .form-select {
      font-weight: 600;
      width: 100%;
    }

    .mpack-standard-sizes {
      font-size: 1rem;
      font-weight: 600;
      color: #0f172a;
      background: #f8fafc;
      border: 1px solid #dbe3f1;
      border-radius: 8px;
      padding: 0.85rem 1rem;
      max-width: 220px;
    }

    .mpack-standard-sizes p {
      margin-bottom: 0.5rem;
    }

    .mpack-standard-sizes ol {
      margin: 0;
      padding-left: 1.25rem;
      font-weight: 500;
    }

    .mpack-standard-sizes li + li {
      margin-top: 0.35rem;
    }

    .mpack-standard-note {
      font-size: 0.95rem;
      font-weight: 600;
      color: #0f172a;
      background: #fff;
      border: 1px dashed #dbe3f1;
      border-radius: 8px;
      padding: 0.65rem 1rem;
    }

    @media (min-width: 992px) {
      .mpack-thickness-row {
        grid-template-columns: auto auto;
      }
    }

    .mpack-pricing-box {
      background-color: #f8fafc;
      border: 1px solid #dbe3f1;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.05);
    }

    .mpack-pricing-breakdown {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .mpack-pricing-row {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding-bottom: 0.35rem;
      border-bottom: 1px solid rgba(15, 23, 42, 0.06);
      font-size: 0.95rem;
    }

    .mpack-pricing-row:last-child,
    .mpack-pricing-row.mpack-pricing-row--total {
      border-bottom: none;
      margin-top: 0.25rem;
      padding-top: 0.75rem;
      border-top: 2px solid rgba(208, 184, 120, 0.5);
      font-weight: 600;
      font-size: 1.05rem;
    }

    .mpack-pricing-label {
      flex: 1;
      font-weight: 600;
      color: #1f2937;
    }

    .mpack-pricing-separator {
      font-weight: 600;
      color: #9ca3af;
    }

    .mpack-pricing-value {
      font-weight: 600;
      color: #0f172a;
    }

    .mpack-pricing-value--discount {
      color: #047857;
    }

    .mpack-pricing-value--total {
      color: #b2872c;
    }
  </style>

  <div class="mb-3">
    <div class="d-flex align-items-end gap-2">
      <div class="flex-grow-1">
        <label for="machineSelect" class="form-label">Select Machine/Model <span class="text-muted small">(optional)</span>:</label>
        <select id="machineSelect" class="form-select">
          <option value="">-- Select Machine --</option>
        </select>
        <div class="form-text text-muted">Leave blank if the machine is unknown. The quotation will display `--`.</div>
      </div>
      <div>
        <a href="{{ url_for('add_machine', next=url_for('mpacks')) }}" class="btn btn-outline-gold">
          <i class="fas fa-plus"></i> New Machine
        </a>
      </div>
    </div>
  </div>

  <!-- Underpacking Type Selection -->
  <div class="mb-3">
    <label for="underpackingType" class="form-label">Select Underpacking Type:</label>
    <select id="underpackingType" class="form-select">
      <option value="">-- Select Underpacking Type --</option>
      <option value="mtech_mpack">Mtech Mpack</option>
      <option value="mark3zet">Mark3zet</option>
    </select>
  </div>

  <div id="mpackSection" style="display:none;">
    <!-- Size selection first -->
    <div class="row mb-4 align-items-start">
      <div class="col-md-6">
        <div class="row g-4 align-items-stretch mb-3">
          <div class="col-md-6 mpack-diagram-column">
            <figure class="mpack-diagram-figure d-flex flex-column align-items-center align-items-md-start text-center text-md-start gap-1 mb-0">
              <svg viewBox="0 0 300 200" width="300" height="190" role="img" aria-labelledby="acrossDiagramTitle acrossDiagramDesc">
                <title id="acrossDiagramTitle">Across direction illustration</title>
                <desc id="acrossDiagramDesc">Cylinder with straight arrow indicating the across measurement.</desc>
                <defs>
                  <marker id="acrossArrowHead" markerWidth="8" markerHeight="8" refX="4" refY="4" orient="auto">
                    <path d="M0,0 L8,4 L0,8 z" fill="#000000" />
                  </marker>
                </defs>
                <g fill="none" stroke="#111827" stroke-width="4" stroke-linecap="round" stroke-linejoin="round">
                  <line x1="35" y1="35" x2="265" y2="35" stroke="#000000" stroke-width="3" marker-start="url(#acrossArrowHead)" marker-end="url(#acrossArrowHead)" />
                  <path d="M70 70 A30 30 0 0 0 70 130" />
                  <path d="M70 70 H230" />
                  <path d="M70 130 H230" />
                  <circle cx="230" cy="100" r="30" />
                </g>
                <text x="150" y="25" text-anchor="middle" font-size="18" font-weight="bold" fill="#000000" style="font-family: Arial, sans-serif;">Across</text>
              </svg>
              <figcaption class="fw-semibold">Across (Cylinder width)</figcaption>
              <span class="text-muted small">Measure straight across the cylinder.</span>
            </figure>
            <div class="mpack-select-wrapper">
              <label class="form-label" for="customWidthInput">Across (mm)</label>
              <select class="form-select" id="customWidthInput">
                <option value="">-- Select Across --</option>
              </select>
            </div>
          </div>
          <div class="col-md-6 mpack-diagram-column">
            <figure class="mpack-diagram-figure d-flex flex-column align-items-center align-items-md-start text-center text-md-start gap-1 mb-0">
              <svg viewBox="0 0 320 180" width="300" height="170" role="img" aria-labelledby="aroundDiagramTitle aroundDiagramDesc">
                <title id="aroundDiagramTitle">Around direction illustration</title>
                <desc id="aroundDiagramDesc">Single cylinder with an exterior wrap arrow indicating the around measurement.</desc>
                <defs>
                  <marker id="aroundTailArrow" viewBox="-12 -12 12 24" markerWidth="12" markerHeight="24" refX="0" refY="0" orient="auto" markerUnits="userSpaceOnUse">
                    <path d="M0 0 L-12 -12 L-12 12 Z" fill="#111827" stroke="#111827" stroke-linejoin="round" />
                  </marker>
                </defs>
                <g fill="none" stroke="#111827" stroke-width="4" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M86 60 A30 30 0 0 0 86 120" />
                  <path d="M86 60 H234" />
                  <path d="M86 120 H234" />
                  <circle cx="234" cy="90" r="30" />
                </g>
                <!-- Wrap arrow from provided SVG, scaled to fit 320Ã—180 viewBox -->
                <g transform="translate(-30,-25) scale(0.72,0.66)" fill="#111827" stroke="none">
                  <path d="M86 150 L110 146 L92 170 Z" />
                  <path d="M186 44 L210 32 L206 58 Z" />
                <path d="M183.649414,89.835205 C182.655426,73.186089 184.362656,57.091713 187.031830,41.290493 C188.795410,30.850109 192.628098,20.456318 199.225388,11.649311 C204.700623,4.340158 213.414825,3.483543 220.083755,9.738154 C222.514313,12.017720 224.981567,12.786819 228.141144,12.698073 C233.466385,12.548501 238.799026,12.637390 244.128296,12.668612 C245.927383,12.679152 247.993668,12.339963 248.953659,14.413435 C249.807892,16.258526 248.344940,17.463015 247.383972,18.815933 C242.401520,25.830639 236.246216,31.896864 231.362091,39.020580 C228.636703,42.995693 226.295364,42.619164 222.866531,39.044819 C216.898087,32.823101 211.337784,26.253902 205.939056,19.541138 C205.307907,18.756374 204.650604,18.001034 202.904999,17.811779 C198.540756,23.777193 195.457794,30.554672 194.755402,38.249294 C194.639923,39.514362 194.747040,40.876865 194.356293,42.097755 C188.645309,59.942547 188.676682,78.168755 190.193771,96.601509 C191.217422,109.039322 192.639343,121.303436 197.036392,133.086823 C198.560150,137.170212 200.560318,140.940826 202.857101,144.616302 C204.885040,147.861526 207.314514,150.887070 211.382996,150.353561 C215.752075,149.780640 217.673767,146.082809 219.241104,142.330704 C217.412033,140.815430 215.501846,141.476059 213.752136,141.392197 C210.086365,141.216507 208.598343,139.368698 210.458786,136.228287 C213.916473,130.391754 216.321274,123.850807 221.168640,118.926369 C223.187668,116.875237 222.527603,113.933815 224.416611,111.813660 C226.388260,109.600716 227.834198,109.060318 230.169937,111.155449 C232.660156,113.389153 234.538345,115.770729 235.488632,119.133682 C236.901566,124.133820 240.288498,128.196045 242.833511,132.662476 C244.075012,134.841293 246.366653,137.203735 244.637878,139.971161 C243.151093,142.351151 240.373230,141.107590 238.150421,141.351624 C237.163132,141.460007 236.134964,141.494125 235.157791,141.346802 C229.985367,140.566986 226.251846,142.099564 223.878571,147.142365 C222.558273,149.947784 220.352142,152.424728 217.653183,154.175415 C211.110352,158.419479 203.423141,156.515137 198.673340,149.354614 C190.781464,137.457275 187.414825,124.010910 185.688889,110.067657 C184.875992,103.500641 184.320877,96.901718 183.649414,89.835205 Z" />
                </g>
                <text x="160" y="25" text-anchor="middle" font-size="18" font-weight="bold" fill="#111827" style="font-family: Arial, sans-serif;">Around</text>
              </svg>
              <figcaption class="fw-semibold">Around (Cylinder circumference)</figcaption>
              <span class="text-muted small">Measure around the cylinder.</span>
            </figure>
            <div class="mpack-select-wrapper">
              <label class="form-label" for="customLengthInput">Around (mm)</label>
              <select class="form-select" id="customLengthInput">
                <option value="">-- Select Around --</option>
              </select>
            </div>
          </div>
        </div>
        <div class="form-text">Select preset sizes to populate measurements automatically.</div>
        <button type="button" class="btn btn-outline-gold btn-sm mt-2" id="toggleManualSizeBtn">Can't find your sizes?</button>
        <div class="card card-body mt-3 d-none" id="manualSizeContainer">
          <p class="mb-3 text-muted" id="manualSizeHint">Tell us your required size and we will calculate the square meter and pricing from the nearest standard roll.</p>
          <div class="row g-3 align-items-end">
            <div class="col-12 col-md-6">
              <label class="form-label" for="manualWidthInput">Across (mm)</label>
              <input type="number" min="0" step="0.5" class="form-control" id="manualWidthInput" placeholder="Enter across width">
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label" for="manualLengthInput">Around (mm)</label>
              <input type="number" min="0" step="0.5" class="form-control" id="manualLengthInput" placeholder="Enter around length">
            </div>
          </div>
          <div class="mt-3">
            <label class="form-label" for="manualThicknessSelect">Thickness (micron)</label>
            <select id="manualThicknessSelect" class="form-select" disabled>
              <option value="">-- Select Thickness --</option>
            </select>
          </div>
          <div class="form-text text-muted mt-2">Thickness will remain selectable from the dropdown above.</div>
        </div>
        <div class="form-text text-muted" id="customSizeSummary">Select sizes to see sq.m., then choose a thickness.</div>
        <div class="text-danger small mt-1 d-none" id="customSizeFeedback">Please enter both across and around measurements to continue.</div>
      </div>
      <div class="col-md-6">
        <div class="mpack-pricing-controls mt-2" id="mpackPricingControls">
          <div class="mpack-thickness-row">
            <div class="mpack-thickness-primary">
              <div>
                <label for="thicknessSelect" class="form-label">Select Thickness (micron)</label>
                <select id="thicknessSelect" class="form-select" disabled>
                  <option value="">-- Select Thickness --</option>
                </select>
                <div class="form-text text-muted mt-2">Thickness options become available once a size is selected.</div>
              </div>
              <div>
                <label for="sheetInput" class="form-label">Quantity (Sheets)</label>
                <input type="number" id="sheetInput" class="form-control" min="1" value="1" />
              </div>
              <div>
                <label for="discountSelect" class="form-label">Discount (%)</label>
                <select id="discountSelect" class="form-select">
                  <option value="">-- Select Discount --</option>
                </select>
              </div>
              <div>
                <label for="gstSelect" class="form-label">GST Rate</label>
                <input type="text" id="gstDisplay" class="form-control" value="18%" disabled>
                <input type="hidden" id="gstSelect" value="18">
              </div>
            </div>
            <div class="mpack-standard-column">
              <div class="mpack-standard-sizes">
                <p class="mb-2">These are our standard (around) sizes:</p>
                <ol class="mb-0">
                  <li>795</li>
                  <li>1150</li>
                  <li>1240</li>
                  <li>1320</li>
                  <li>1540</li>
                </ol>
              </div>
              <div class="mpack-standard-note">Cut from size (roll)</div>
              <label for="cutFromSizeSelect" class="form-label mb-1">Cut size (auto)</label>
              <select id="cutFromSizeSelect" class="form-select" disabled>
                <option value="" selected>----</option>
                <option value="795">795 mm</option>
                <option value="1150">1150 mm</option>
                <option value="1240">1240 mm</option>
                <option value="1320">1320 mm</option>
                <option value="1540">1540 mm</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="cutQuestionSection" class="card mb-3" style="display:none;">
      <div class="card-body">
        <label class="form-label d-block">Should we cut the underpacking to your entered size?</label>
        <div class="d-flex flex-wrap align-items-start gap-4">
          <div class="form-check">
            <input class="form-check-input" type="radio" name="cutFromInput" id="cutYes" value="yes">
            <label class="form-check-label" for="cutYes">
              Yes
              <span class="text-muted small d-block">(Price will still be taken as per standard sizes considering wastage.)</span>
            </label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="cutFromInput" id="cutNo" value="no">
            <label class="form-check-label" for="cutNo">No</label>
          </div>
        </div>
      </div>
    </div>

    <div id="cutDetailsSection" class="alert alert-info" style="display:none;">
      <h6 class="mb-2">Cutting summary</h6>
      <div class="d-flex justify-content-between" id="cutStandardRow" style="display:none;">
        <span>Standard sheet area:</span>
        <span><strong><span id="standardAreaDisplay">0.000</span> sq.m</strong></span>
      </div>
      <div class="d-flex justify-content-between" id="cutCustomRow" style="display:none;">
        <span>Your required size area:</span>
        <span><strong><span id="customAreaDisplay">0.000</span> sq.m</strong></span>
      </div>
      <p class="mb-0 text-muted small" id="cutDetailsNote">Select whether we should cut to your entered size. Pricing remains based on the selected standard size.</p>
    </div>

    <section class="pricing-section" id="priceSection" style="display:none;">
      <div class="pricing-container">
        <div class="pricing-preview mb-3 mpack-pricing-box">
          <div class="pricing-breakdown mpack-pricing-breakdown" id="pricingBreakdown">
            <p class="text-muted mb-0">Select thickness and sizes to see pricing.</p>
          </div>
        </div>
        <div class="pricing-actions">
          <button class="btn btn-primary" id="addToCartBtn" disabled>Add to Cart</button>
        </div>
        <div id="cart-message" class="mt-2"></div>
      </div>
    </section>
  </div>

  <!-- Scripts -->
  <script src="{{ url_for('static', filename='user/js/mpack.js') }}"></script>
  <script src="{{ url_for('static', filename='user/js/cart.js') }}"></script>
  <script>
    // Initialize cart count when page loads
    document.addEventListener('DOMContentLoaded', function() {
      updateCartCount();
      
      // Initialize size search functionality
      function initSizeSearch() {
        const sizeInput = document.getElementById('sizeInput');
        const sizeSelect = document.getElementById('sizeSelect');
        const sizeSuggestions = document.getElementById('sizeSuggestions');
        if (!sizeInput || !sizeSelect) return;

        // Update hidden select and trigger change
        function selectSize(value, text) {
          sizeSelect.value = value;
          sizeInput.value = text;
          sizeSuggestions.style.display = 'none';
          setTimeout(() => {
            sizeSelect.dispatchEvent(new Event('change'));
          }, 10);
        }

        // Update suggestion list
        function updateSuggestions() {
          const searchTerm = sizeInput.value.toLowerCase();
          const options = Array.from(sizeSelect.options);
          sizeSuggestions.innerHTML = '';
          if (!searchTerm) { sizeSuggestions.style.display = 'none'; return; }
          const matches = options.filter(opt => opt.value && (opt.text.toLowerCase().includes(searchTerm) || opt.text.replace(/[^0-9x]/g,'').includes(searchTerm)));
          const list = matches.length ? matches : [{text:'No matching sizes found', value:''}];
          list.forEach(opt => {
            const el = document.createElement(matches.length ? 'button' : 'div');
            if (matches.length) {
              el.type='button'; el.className='list-group-item list-group-item-action'; el.textContent=opt.text;
              el.onclick=()=>selectSize(opt.value, opt.text);
            } else { el.className='list-group-item'; el.textContent=opt.text; }
            sizeSuggestions.appendChild(el);
          });
          sizeSuggestions.style.display='block';
        }

        sizeInput.addEventListener('input', updateSuggestions);
        document.addEventListener('click', e => { if (e.target!==sizeInput && e.target!==sizeSuggestions) sizeSuggestions.style.display='none'; });
        sizeInput.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); const first=sizeSuggestions.querySelector('button'); first && first.click(); }});
        new MutationObserver(updateSuggestions).observe(sizeSelect,{childList:true});
        updateSuggestions();
      }

      // Initialize size search functionality
      initSizeSearch();
      
      // Show/hide discount section
      window.showDiscountSection = function() {
        const discountSection = document.getElementById('discountSection');
        if (discountSection) {
          discountSection.style.display = discountSection.style.display === 'none' ? 'block' : 'none';
        }
      };
    });
  </script>
{% endblock %}