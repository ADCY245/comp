{% extends "base.html" %}

{% block title %}MPACK Selection - Product Calculator{% endblock %}

{% block content %}
  <div class="container my-5">
  <h2>MPACK Selection</h2>

  <div class="mb-3">
    <div class="d-flex align-items-end gap-2">
      <div class="flex-grow-1">
        <label for="machineSelect" class="form-label">Select Machine/Model <span class="text-muted small">(optional)</span>:</label>
        <select id="machineSelect" class="form-select">
          <option value="">-- Select Machine --</option>
        </select>
        <div class="form-text text-muted">Leave blank if the machine is unknown. The quotation will display `--`.</div>
      </div>
      <div>
        <a href="{{ url_for('add_machine', next=url_for('mpacks')) }}" class="btn btn-outline-gold">
          <i class="fas fa-plus"></i> New Machine
        </a>
      </div>
    </div>
  </div>

  <!-- Underpacking Type Selection -->
  <div class="mb-3">
    <label for="underpackingType" class="form-label">Select Underpacking Type:</label>
    <select id="underpackingType" class="form-select">
      <option value="">-- Select Underpacking Type --</option>
      <option value="mtech_mpack">Mtech Mpack</option>
      <option value="mark3zet">Mark3zet</option>
    </select>
  </div>

  <div id="mpackSection" style="display:none;">
    <!-- Thickness -->
    <div class="row mb-3 align-items-end">
      <div class="col-md-4">
        <label for="thicknessSelect" class="form-label">Select Thickness (micron):</label>
        <select id="thicknessSelect" class="form-select">
          <option value="">-- Select Thickness --</option>
          <option value="100">100</option>
          <option value="125">125</option>
          <option value="150">150</option>
          <option value="200">200</option>
          <option value="250">250</option>
          <option value="300">300</option>
          <option value="400">400</option>
        </select>
      </div>
      <div class="col-md-8">
        <div class="row g-4 align-items-start mb-3">
          <div class="col-md-6">
            <figure class="d-flex flex-column align-items-center align-items-md-start text-center text-md-start gap-1 mb-0">
              <svg viewBox="0 0 300 200" width="300" height="190" role="img" aria-labelledby="acrossDiagramTitle acrossDiagramDesc">
                <title id="acrossDiagramTitle">Across direction illustration</title>
                <desc id="acrossDiagramDesc">Cylinder with straight arrow indicating the across measurement.</desc>
                <defs>
                  <marker id="acrossArrowHead" markerWidth="8" markerHeight="8" refX="4" refY="4" orient="auto">
                    <path d="M0,0 L8,4 L0,8 z" fill="#000000" />
                  </marker>
                </defs>
                <g fill="none" stroke="#111827" stroke-width="4" stroke-linecap="round" stroke-linejoin="round">
                  <line x1="35" y1="35" x2="265" y2="35" stroke="#000000" stroke-width="3" marker-start="url(#acrossArrowHead)" marker-end="url(#acrossArrowHead)" />
                  <rect x="40" y="60" width="220" height="50" rx="25" ry="25" />
                  <rect x="40" y="110" width="220" height="50" rx="25" ry="25" />
                  <circle cx="235" cy="85" r="25" />
                  <circle cx="235" cy="135" r="25" />
                </g>
                <text x="150" y="25" text-anchor="middle" font-size="18" font-weight="bold" fill="#000000" style="font-family: Arial, sans-serif;">Across</text>
              </svg>
              <figcaption class="fw-semibold">Across (Cylinder width)</figcaption>
              <span class="text-muted small">Measure straight across the cylinder.</span>
            </figure>
            <div class="mt-3">
              <label class="form-label" for="customWidthInput">Across (mm)</label>
              <input type="number" class="form-control" id="customWidthInput" placeholder="Enter width" min="0" step="0.1">
            </div>
          </div>
          <div class="col-md-6">
            <figure class="d-flex flex-column align-items-center align-items-md-start text-center text-md-start gap-1 mb-0">
              <svg viewBox="0 0 240 210" width="240" height="190" role="img" aria-labelledby="aroundDiagramTitle aroundDiagramDesc">
                <title id="aroundDiagramTitle">Around direction illustration</title>
                <desc id="aroundDiagramDesc">Single cylinder with an arrow wrapping around the circumference to indicate the around measurement.</desc>
                <defs>
                  <linearGradient id="aroundCylinderFill" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" stop-color="#FFFFFF" />
                    <stop offset="60%" stop-color="#E5E7EB" />
                    <stop offset="100%" stop-color="#D1D5DB" />
                  </linearGradient>
                  <marker id="aroundArrowHead" markerWidth="7" markerHeight="7" refX="3.5" refY="3.5" orient="auto">
                    <path d="M0,0 L7,3.5 L0,7 z" fill="#6B7280" />
                  </marker>
                </defs>
                <g stroke="#111827" stroke-width="3.5" stroke-linecap="round" stroke-linejoin="round">
                  <ellipse cx="110" cy="65" rx="72" ry="30" fill="#F3F4F6" />
                  <path d="M38 65 V140 C38 171 71 198 110 198 C149 198 182 171 182 140 V65" fill="url(#aroundCylinderFill)" />
                  <ellipse cx="110" cy="140" rx="72" ry="30" fill="#E5E7EB" />
                  <ellipse cx="110" cy="140" rx="72" ry="30" fill="none" stroke="#9CA3AF" stroke-dasharray="10 12" />
                </g>
                <path d="M116 196 C46 188 18 130 36 82 C52 42 101 15 150 32" fill="none" stroke="#6B7280" stroke-width="3" marker-start="url(#aroundArrowHead)" marker-end="url(#aroundArrowHead)" />
                <text x="118" y="112" text-anchor="middle" font-size="18" font-weight="bold" fill="#6B7280" style="font-family: Arial, sans-serif; text-shadow: 0 0 2px rgba(255,255,255,0.8);">Around</text>
              </svg>
              <figcaption class="fw-semibold">Around (Cylinder circumference)</figcaption>
              <span class="text-muted small">Measure around the cylinder.</span>
            </figure>
            <div class="mt-3">
              <label class="form-label" for="customLengthInput">Around (mm)</label>
              <input type="number" class="form-control" id="customLengthInput" placeholder="Enter circumference" min="0" step="0.1">
            </div>
          </div>
        </div>
        <div class="form-text">Use decimal values if needed. Example: Across 540.25 mm × Around 640.5 mm.</div>
        <div class="form-text text-muted" id="customSizeSummary">Awaiting across/around input…</div>
        <div class="text-danger small mt-1 d-none" id="customSizeFeedback">Please enter both across and around measurements to continue.</div>
      </div>
    </div>

    <!-- Size with Search -->
    <div class="row mb-3">
      <div class="col-12">
        <label for="sizeInput" class="form-label">Select Chemo standard size:</label>
        <div class="search-container">
          <input type="text" id="sizeInput" class="form-control" placeholder="Type to search sizes (e.g., 260x350)">
          <div id="sizeSuggestions" class="list-group mt-2" style="display:none;max-height:200px;overflow-y:auto;position: absolute;width: 100%;z-index: 1000;"></div>
        </div>
        <select id="sizeSelect" style="display:none;">
          <option value="">-- Select Size --</option>
        </select>
      </div>
    </div>

    <div id="cutQuestionSection" class="card mb-3" style="display:none;">
      <div class="card-body">
        <label class="form-label d-block">Should we cut the underpacking to your entered size?</label>
        <div class="d-flex flex-wrap align-items-start gap-4">
          <div class="form-check">
            <input class="form-check-input" type="radio" name="cutFromInput" id="cutYes" value="yes">
            <label class="form-check-label" for="cutYes">
              Yes
              <span class="text-muted small d-block">(Price will still be taken as per standard sizes considering wastage.)</span>
            </label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="cutFromInput" id="cutNo" value="no">
            <label class="form-check-label" for="cutNo">No</label>
          </div>
        </div>
      </div>
    </div>

    <div id="cutDetailsSection" class="alert alert-info" style="display:none;">
      <h6 class="mb-2">Cutting summary</h6>
      <div class="d-flex justify-content-between" id="cutStandardRow" style="display:none;">
        <span>Standard sheet area:</span>
        <span><strong><span id="standardAreaDisplay">0.000</span> sq.m</strong></span>
      </div>
      <div class="d-flex justify-content-between" id="cutCustomRow" style="display:none;">
        <span>Your required size area:</span>
        <span><strong><span id="customAreaDisplay">0.000</span> sq.m</strong></span>
      </div>
      <p class="mb-0 text-muted small" id="cutDetailsNote">Select whether we should cut to your entered size. Pricing remains based on the selected standard size.</p>
    </div>

    <!-- Price Calculation Section -->
    <div class="card mb-3" id="priceSection" style="display:none;">
      <div class="card-body">
        <h5 class="card-title">Price Calculation</h5>
        <div class="row">
          <div class="col-md-6">
            <p id="netPriceDisplay" class="mb-1"><strong>Net Price Per Sheet:</strong> ₹<span id="netPrice">-</span></p>
          </div>
          <div class="col-md-6">
            <div class="mb-2">
              <label for="sheetInput" class="form-label">Quantity (Sheets):</label>
              <input type="number" id="sheetInput" class="form-control form-control-sm" min="1" value="1" />
            </div>
            <!-- Discount Section -->
            <div class="mb-3" id="discountSection">
              <label for="discountSelect" class="form-label">Select Discount:</label>
              <select id="discountSelect" class="form-select form-select-sm">
                <option value="">-- Select Discount --</option>
              </select>
              <div id="discountDetails" class="mt-2 p-2 bg-light rounded"></div>
            </div>
            <div class="mb-2">
              <label for="gstSelect" class="form-label">GST Rate: 18%</label>
              <input type="hidden" id="gstSelect" value="18">
            </div>
          </div>
        </div>

        <!-- Price Summary -->
        <div class="card mt-3">
          <div class="card-body p-3">
            <h5 class="fw-bold mb-3">Price Summary</h5>
            <div id="priceSummary">
              <p class="text-muted mb-0">Select options to see pricing</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Add to Cart Button -->
    <button id="addToCartBtn" class="btn btn-primary" style="display:none;">Add to Cart</button>
    <div id="cart-message" class="mt-2"></div>
  </div>

  <!-- Scripts -->
  <script src="{{ url_for('static', filename='user/js/mpack.js') }}"></script>
  <script src="{{ url_for('static', filename='user/js/cart.js') }}"></script>
  <script>
    // Initialize cart count when page loads
    document.addEventListener('DOMContentLoaded', function() {
      updateCartCount();
      
      // Initialize size search functionality
      function initSizeSearch() {
        const sizeInput = document.getElementById('sizeInput');
        const sizeSelect = document.getElementById('sizeSelect');
        const sizeSuggestions = document.getElementById('sizeSuggestions');
        if (!sizeInput || !sizeSelect) return;

        // Update hidden select and trigger change
        function selectSize(value, text) {
          sizeSelect.value = value;
          sizeInput.value = text;
          sizeSuggestions.style.display = 'none';
          setTimeout(() => {
            sizeSelect.dispatchEvent(new Event('change'));
          }, 10);
        }

        // Update suggestion list
        function updateSuggestions() {
          const searchTerm = sizeInput.value.toLowerCase();
          const options = Array.from(sizeSelect.options);
          sizeSuggestions.innerHTML = '';
          if (!searchTerm) { sizeSuggestions.style.display = 'none'; return; }
          const matches = options.filter(opt => opt.value && (opt.text.toLowerCase().includes(searchTerm) || opt.text.replace(/[^0-9x]/g,'').includes(searchTerm)));
          const list = matches.length ? matches : [{text:'No matching sizes found', value:''}];
          list.forEach(opt => {
            const el = document.createElement(matches.length ? 'button' : 'div');
            if (matches.length) {
              el.type='button'; el.className='list-group-item list-group-item-action'; el.textContent=opt.text;
              el.onclick=()=>selectSize(opt.value, opt.text);
            } else { el.className='list-group-item'; el.textContent=opt.text; }
            sizeSuggestions.appendChild(el);
          });
          sizeSuggestions.style.display='block';
        }

        sizeInput.addEventListener('input', updateSuggestions);
        document.addEventListener('click', e => { if (e.target!==sizeInput && e.target!==sizeSuggestions) sizeSuggestions.style.display='none'; });
        sizeInput.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); const first=sizeSuggestions.querySelector('button'); first && first.click(); }});
        new MutationObserver(updateSuggestions).observe(sizeSelect,{childList:true});
        updateSuggestions();
      }

      // Initialize size search functionality
      initSizeSearch();
      
      // Show/hide discount section
      window.showDiscountSection = function() {
        const discountSection = document.getElementById('discountSection');
        if (discountSection) {
          discountSection.style.display = discountSection.style.display === 'none' ? 'block' : 'none';
        }
      };
    });
  </script>
{% endblock %}
